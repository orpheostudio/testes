<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>ùë∫ùíÜùíèùíÇ ‚úß - Tecnologia com alma gentil</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="description" content="Assistente AI multifuncional com chat, an√°lise de documentos, gera√ß√£o de imagens, c√≥digo e muito mais">
    <link rel="apple-touch-icon" href="https://i.imgur.com/ivFEqQU.png">

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "tlya8thx8r"); 
    </script>

    <style>
        :root {
    --primary: #6c5ce7; 
    --primary-dark: #4834d4;
    --primary-light: #a29bfe;
    --success: #00b894;
    --warning: #fdcb6e;
    --danger: #d63031;
    --info: #0984e3;
    --bg-app: #f5f6fa;
    --bg-chat: #ffffff;
    --bg-card: #ffffff;
    --text-main: #2d3436;
    --text-secondary: #636e72;
    --cici-bubble: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
    --cici-text: #ffffff;
    --user-bubble: #fab1a0;
    --user-text: #2d3436;
    --border-color: #dfe6e9;
    --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
    --shadow-md: 0 2px 8px rgba(0,0,0,0.12);
    --shadow-lg: 0 4px 15px rgba(0,0,0,0.15);
    --menu-bg: rgba(255, 255, 255, 0.98);
    --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
}

/* Tema Escuro para iPhone */
@media (prefers-color-scheme: dark) {
    body:not(.alto-contraste) {
        --primary: #a29bfe;
        --primary-dark: #6c5ce7;
        --bg-app: #000000;
        --bg-chat: #1c1c1e;
        --bg-card: #2c2c2e;
        --text-main: #ffffff;
        --text-secondary: #98989f;
        --cici-bubble: linear-gradient(135deg, #6c5ce7 0%, #4834d4 100%);
        --user-bubble: #ff6b6b;
        --border-color: #38383a;
        --menu-bg: rgba(44, 44, 46, 0.95);
    }
}

/* Alto Contraste */
body.alto-contraste {
    --primary: #ffffff;
    --primary-dark: #cccccc;
    --bg-app: #000000;
    --bg-chat: #000000;
    --bg-card: #000000;
    --text-main: #ffff00;
    --text-secondary: #ffff00;
    --cici-bubble: #ffff00;
    --cici-text: #000000;
    --user-bubble: #ffff00;
    --user-text: #000000;
    --border-color: #ffff00;
    --shadow-sm: 0 0 0 1px #ffff00;
}

* {
    box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
}

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background-color: var(--bg-app);
    color: var(--text-main);
    font-size: 17px; /* Tamanho padr√£o iOS */
    -webkit-text-size-adjust: 100%; /* Prevenir zoom autom√°tico */
}

/* Layout Principal - Otimizado para Safe Area */
#tela-app {
    display: flex;
    flex-direction: column;
    height: 100vh;
    height: -webkit-fill-available;
    max-height: 100vh;
    width: 100%;
    padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
}

/* Header iPhone */
.app-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 12px;
    background: rgba(20, 20, 26, 0.92);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border-bottom: 0.5px solid rgba(255,255,255,0.1);
    flex-shrink: 0;
    min-height: 44px; /* Tamanho m√≠nimo touch iOS */
}

/* Bot√µes com tamanho touch ideal */
.menu-btn, .header-action {
    background: transparent;
    border: none;
    padding: 8px;
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    border-radius: 10px;
    transition: var(--transition);
}

.menu-btn:active, .header-action:active {
    background: rgba(255,255,255,0.1);
    transform: scale(0.95);
}

.icone-menu, .icone-header {
    width: 22px;
    height: 22px;
    object-fit: contain;
}

.logo-area .logo {
    width: 36px;
    height: 36px;
    object-fit: contain;
}

/* Menu Lateral iPhone */
#overlay-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.4);
    z-index: 1000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
}

#overlay-menu.aberto {
    opacity: 1;
    pointer-events: all;
}

#side-menu {
    position: fixed;
    top: 0;
    left: -100%;
    width: 280px;
    height: 100%;
    background: var(--menu-bg);
    z-index: 1001;
    transition: left 0.35s cubic-bezier(0.4, 0, 0.2, 1);
    padding: 20px 16px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    box-shadow: 2px 0 15px rgba(0,0,0,0.3);
    backdrop-filter: blur(30px);
    -webkit-backdrop-filter: blur(30px);
    overflow-y: auto;
}

#side-menu.aberto { 
    left: 0; 
}

.menu-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
    padding-bottom: 16px;
    border-bottom: 0.5px solid var(--border-color);
}

.menu-close {
    background: var(--danger);
    border: none;
    color: white;
    width: 40px;
    height: 40px;
    border-radius: 10px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.1em;
}

.menu-item {
    background: none;
    border: none;
    color: var(--text-main);
    padding: 16px 14px;
    text-align: left;
    font-size: 16px;
    font-weight: 500;
    border-radius: 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 14px;
    transition: var(--transition);
    min-height: 44px;
}

.menu-item:active {
    background-color: var(--primary);
    color: white;
}

.toggle-switch {
    width: 52px;
    height: 32px;
    background: var(--border-color);
    border-radius: 16px;
    position: relative;
    cursor: pointer;
    transition: var(--transition);
    margin-left: auto;
    flex-shrink: 0;
}

.toggle-switch.ativo {
    background: var(--success);
}

.toggle-switch::after {
    content: '';
    position: absolute;
    width: 28px;
    height: 28px;
    background: white;
    border-radius: 50%;
    top: 2px;
    left: 2px;
    transition: var(--transition);
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

.toggle-switch.ativo::after {
    left: 22px;
}

/* √Årea de Chat - Otimizada para iPhone */
#chat-container {
    flex: 1;
    padding: 12px 10px;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 12px;
    background: var(--bg-chat);
    scroll-behavior: smooth;
    min-height: 0;
    -webkit-overflow-scrolling: touch; /* Scroll suave iOS */
}

#chat-container::-webkit-scrollbar { 
    display: none; /* Esconder scrollbar iOS */
}

/* Mensagens para iPhone */
.mensagem-wrapper {
    display: flex;
    flex-direction: column;
    max-width: 88%;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from { 
        opacity: 0; 
        transform: translateY(8px); 
    }
    to { 
        opacity: 1; 
        transform: translateY(0); 
    }
}

.cici-wrapper { 
    align-self: flex-start; 
}

.usuario-wrapper { 
    align-self: flex-end; 
    align-items: flex-end; 
}

.mensagem {
    padding: 12px 16px;
    border-radius: 18px;
    line-height: 1.4;
    box-shadow: var(--shadow-sm);
    word-wrap: break-word;
    position: relative;
    font-size: 16px;
    word-break: break-word;
}

.cici {
    background: var(--cici-bubble);
    color: var(--cici-text);
    border-bottom-left-radius: 6px;
}

.usuario {
    background-color: var(--user-bubble);
    color: var(--user-text);
    border-bottom-right-radius: 6px;
}

.mensagem-hora {
    font-size: 13px;
    opacity: 0.7;
    margin-top: 4px;
}

.mensagem-acoes {
    display: flex;
    gap: 6px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.btn-acao {
    background: rgba(0,0,0,0.08);
    border: none;
    color: var(--text-secondary);
    font-size: 13px;
    cursor: pointer;
    display: flex;
    gap: 4px;
    align-items: center;
    padding: 6px 10px;
    border-radius: 8px;
    transition: var(--transition);
    font-weight: 500;
    min-height: 32px;
}

.btn-acao:active {
    background: var(--primary);
    color: white;
    transform: scale(0.96);
}

/* Sugest√µes iPhone */
.sugestoes-container {
    padding: 10px 12px;
    background: linear-gradient(to top, rgba(20,20,28,0.95), rgba(20,20,28,0));
    flex-shrink: 0;
    border-top: 0.5px solid rgba(255,255,255,0.1);
}

.sugestoes-scroll {
    display: flex;
    gap: 8px;
    overflow-x: auto;
    scrollbar-width: none;
    padding-bottom: 2px;
    -webkit-overflow-scrolling: touch;
}

.sugestoes-scroll::-webkit-scrollbar {
    display: none;
}

.chip {
    display: flex;
    align-items: center;
    gap: 6px;
    background: rgba(255,255,255,0.12);
    border: 0.5px solid rgba(255,255,255,0.2);
    padding: 10px 14px;
    border-radius: 20px;
    color: #fff;
    white-space: nowrap;
    cursor: pointer;
    transition: var(--transition);
    flex-shrink: 0;
    font-size: 15px;
    font-weight: 500;
    min-height: 36px;
}

.chip:active {
    background: rgba(255,255,255,0.2);
    transform: scale(0.96);
}

/* √Årea de Input iPhone */
footer {
    background: var(--bg-chat);
    padding: 12px 10px;
    border-top: 0.5px solid var(--border-color);
    flex-shrink: 0;
    padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px));
}

.input-tools {
    display: flex;
    gap: 6px;
    margin-bottom: 10px;
    overflow-x: auto;
    padding-bottom: 2px;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
}

.input-tools::-webkit-scrollbar {
    display: none;
}

.tool-btn {
    background: var(--bg-card);
    border: 0.5px solid var(--border-color);
    color: var(--text-main);
    padding: 8px 12px;
    border-radius: 10px;
    font-size: 14px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    white-space: nowrap;
    transition: var(--transition);
    font-weight: 500;
    flex-shrink: 0;
    min-height: 36px;
}

.tool-btn:active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
    transform: scale(0.96);
}

.input-area {
    display: flex;
    gap: 8px;
    align-items: flex-end;
}

.input-container {
    flex: 1;
    position: relative;
    display: flex;
    flex-direction: column;
    min-width: 0;
}

#entradaUsuario {
    width: 100%;
    max-height: 120px;
    min-height: 40px;
    resize: none;
    padding: 12px 16px;
    border-radius: 20px;
    font-size: 17px;
    line-height: 1.4;
    border: 0.5px solid var(--border-color);
    background: var(--bg-card);
    color: var(--text-main);
    caret-color: var(--primary);
    font-family: inherit;
    transition: var(--transition);
    -webkit-user-select: text;
    user-select: text;
}

#entradaUsuario:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 2px rgba(108, 92, 231, 0.15);
}

#entradaUsuario::placeholder {
    color: var(--text-secondary);
    opacity: 0.7;
}

.input-actions {
    display: flex;
    gap: 8px;
    align-items: center;
    flex-shrink: 0;
}

#btn-mic, #btn-attach {
    background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
    color: white;
    width: 44px;
    height: 44px;
    min-width: 44px;
    border-radius: 50%;
    border: none;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
}

#btn-attach {
    background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
}

#btn-mic:active, #btn-attach:active {
    transform: scale(0.92);
}

#btn-mic.ouvindo {
    background: linear-gradient(135deg, var(--success) 0%, #00b894 100%);
    animation: pulse 1.5s infinite;
}

.btn-send {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    color: white;
    padding: 0 20px;
    height: 44px;
    border-radius: 22px;
    border: none;
    font-weight: 600;
    cursor: pointer;
    box-shadow: var(--shadow-md);
    transition: var(--transition);
    font-size: 16px;
    white-space: nowrap;
    display: flex;
    align-items: center;
    justify-content: center;
    min-width: 70px;
}

.btn-send:active {
    transform: scale(0.95);
}

.btn-send:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
}

@keyframes pulse {
    0%, 100% { 
        transform: scale(1); 
    }
    50% { 
        transform: scale(1.05); 
    }
}

/* Modal iPhone */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
}

.card-aviso {
    width: 100%;
    max-width: 320px;
    padding: 24px 20px;
    background: var(--bg-card);
    border: 0.5px solid var(--border-color);
    border-radius: 20px;
    color: var(--text-main);
    text-align: center;
    box-shadow: var(--shadow-lg);
    animation: fadeZoom 0.3s ease;
}

@keyframes fadeZoom {
    0% {
        opacity: 0;
        transform: scale(0.9);
    }
    100% {
        opacity: 1;
        transform: scale(1);
    }
}

.aviso-titulo {
    font-size: 20px;
    margin-bottom: 16px;
    font-weight: 700;
}

.aviso-lista {
    text-align: left;
    line-height: 1.5;
    font-size: 16px;
    margin: 16px 0 20px;
}

.btn-grande {
    width: 100%;
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
    padding: 16px 0;
    border-radius: 14px;
    border: none;
    color: white;
    font-size: 17px;
    cursor: pointer;
    font-weight: 600;
    transition: var(--transition);
    min-height: 50px;
}

.btn-grande:active {
    transform: scale(0.98);
}

/* Toast iPhone */
.toast {
    position: fixed;
    bottom: 80px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    background: var(--bg-card);
    color: var(--text-main);
    padding: 14px 18px;
    border-radius: 14px;
    box-shadow: var(--shadow-lg);
    z-index: 1500;
    display: flex;
    align-items: center;
    gap: 10px;
    min-width: 200px;
    max-width: calc(100% - 32px);
    opacity: 0;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border: 0.5px solid var(--border-color);
    font-size: 15px;
}

.toast.mostrar {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
}

.oculto { 
    display: none !important; 
}

/* Markdown para iPhone */
.mensagem p { 
    margin: 6px 0; 
    line-height: 1.4; 
    font-size: 16px;
}

.mensagem ul, .mensagem ol { 
    margin: 8px 0; 
    padding-left: 20px; 
    line-height: 1.5; 
}

.mensagem li { 
    margin: 4px 0; 
}

.mensagem code:not(.hljs) { 
    background: rgba(0,0,0,0.1); 
    padding: 2px 6px; 
    border-radius: 4px; 
    font-family: 'Menlo', 'Courier New', monospace;
    font-size: 14px;
}

.mensagem pre {
    background: #1e1e1e;
    padding: 14px;
    border-radius: 10px;
    overflow-x: auto;
    margin: 10px 0;
    -webkit-overflow-scrolling: touch;
}

.mensagem a { 
    color: var(--primary); 
    text-decoration: underline;
    font-weight: 500;
}

/* Media Queries espec√≠ficas para iPhone */
/* iPhone SE e menores */
@media (max-width: 320px) {
    .app-header {
        padding: 6px 10px;
    }
    
    #chat-container {
        padding: 10px 8px;
        gap: 10px;
    }
    
    .mensagem-wrapper {
        max-width: 92%;
    }
    
    .mensagem {
        padding: 10px 14px;
        font-size: 15px;
    }
    
    .sugestoes-container {
        padding: 8px 10px;
    }
    
    .chip {
        padding: 8px 12px;
        font-size: 14px;
    }
    
    footer {
        padding: 10px 8px;
    }
    
    #entradaUsuario {
        padding: 10px 14px;
        font-size: 16px;
    }
    
    .card-aviso {
        padding: 20px 16px;
    }
    
    .aviso-titulo {
        font-size: 18px;
    }
}

/* iPhone Plus e maiores */
@media (min-width: 414px) {
    .app-header {
        padding: 10px 16px;
    }
    
    #chat-container {
        padding: 16px 14px;
    }
    
    .mensagem-wrapper {
        max-width: 85%;
    }
    
    footer {
        padding: 16px 14px;
    }
}

/* iPad */
@media (min-width: 768px) {
    .app-header {
        padding: 12px 20px;
    }
    
    #chat-container {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
    }
    
    .mensagem-wrapper {
        max-width: 80%;
    }
    
    footer {
        padding: 20px;
        max-width: 800px;
        margin: 0 auto;
        width: 100%;
    }
}

/* Suporte para orienta√ß√£o paisagem iPhone */
@media (max-height: 400px) and (orientation: landscape) {
    .app-header {
        min-height: 40px;
        padding: 4px 12px;
    }
    
    #chat-container {
        padding: 8px 10px;
        gap: 8px;
    }
    
    .mensagem {
        padding: 8px 12px;
    }
    
    footer {
        padding: 8px 10px;
    }
    
    .sugestoes-container {
        display: none; /* Esconder sugest√µes em paisagem para economizar espa√ßo */
    }
}

/* Melhorias de acessibilidade iOS */
button, input, textarea {
    -webkit-appearance: none;
    border-radius: 0;
}

input, textarea {
    font-size: 16px !important; /* Prevenir zoom em iOS */
}

/* Safe Area support melhorado */
@supports (padding: max(0px)) {
    #tela-app {
        padding-left: max(12px, env(safe-area-inset-left));
        padding-right: max(12px, env(safe-area-inset-right));
        padding-top: max(8px, env(safe-area-inset-top));
        padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
    
    footer {
        padding-bottom: max(12px, env(safe-area-inset-bottom));
    }
}

/* Prevenir sele√ß√£o de texto em elementos interativos */
button, .chip, .tool-btn {
    -webkit-user-select: none;
    user-select: none;
    -webkit-touch-callout: none;
}

/* Feedback t√°til melhorado */
@media (hover: none) and (pointer: coarse) {
    .menu-item:hover,
    .chip:hover,
    .tool-btn:hover,
    .btn-acao:hover {
        background: initial;
        transform: initial;
    }
    
    .menu-item:active,
    .chip:active,
    .tool-btn:active,
    .btn-acao:active {
        background: var(--primary);
        transform: scale(0.96);
    }
}
    </style>
</head>
<body>
    <a href="#chat-container" class="skip-link">Pular para o chat</a>

    <div id="overlay-menu" onclick="fecharMenu()"></div>

    <nav id="side-menu" role="navigation">
        <div class="menu-header">
            <h2 style="margin:0; font-size:1.3em;">‚öôÔ∏è Configura√ß√µes</h2>
            <button class="menu-close" onclick="fecharMenu()">‚úï</button>
        </div>

        <div class="menu-titulo">üé® Apar√™ncia</div>
        <button class="menu-item" onclick="alternarTemaEscuro()">
            <span id="icone-tema">üåô</span>
            <span id="texto-tema">Modo Escuro</span>
            <div class="toggle-switch" id="toggle-tema"></div>
        </button>
        <button class="menu-item" onclick="alternarContraste()">
            <span>üåì</span>
            <span>Alto Contraste</span>
            <div class="toggle-switch" id="toggle-contraste"></div>
        </button>
        <button class="menu-item" onclick="alternarLeituraFacilitada()">
            <span>üìñ</span>
            <span>Leitura Facilitada</span>
            <div class="toggle-switch" id="toggle-leitura"></div>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üî§ Tamanho do Texto</div>
        <button class="menu-item" onclick="ajustarFonte(2)">
            <span>üîç</span>
            <span>Aumentar Letra</span>
        </button>
        <button class="menu-item" onclick="ajustarFonte(-2)">
            <span>üîé</span>
            <span>Diminuir Letra</span>
        </button>
        <button class="menu-item" onclick="resetarFonte()">
            <span>‚Ü©Ô∏è</span>
            <span>Tamanho Padr√£o</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üîä √Åudio</div>
        <button class="menu-item" onclick="alternarSom()">
            <span id="icone-som">üéôÔ∏è</span>
            <span id="texto-som">Ativar Voz</span>
            <div class="toggle-switch" id="toggle-som"></div>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(-0.2)">
            <span>üê¢</span>
            <span>Voz Mais Lenta</span>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(0.2)">
            <span>‚ö°</span>
            <span>Voz Mais R√°pida</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üìÇ A√ß√µes</div>
        <button class="menu-item" onclick="exportarConversa()">
            <span>üíæ</span>
            <span>Salvar Conversa</span>
        </button>
        <button class="menu-item" onclick="compartilharConversa()">
            <span>‚õìÔ∏è‚Äçüí•</span>
            <span>Compartilhar</span>
        </button>
        <button class="menu-item" onclick="imprimirConversa()">
            <span>üñ®Ô∏è</span>
            <span>Imprimir</span>
        </button>
        <button class="menu-item" onclick="limparChat()" style="color: var(--danger);">
            <span>üóëÔ∏è</span>
            <span>Limpar Conversa</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">‚ùì Ajuda</div>
        <button class="menu-item" onclick="mostrarAjuda()">
            <span>üìö</span>
            <span>Como Usar</span>
        </button>
        <button class="menu-item" onclick="mostrarCapacidades()">
            <span>üöÄ</span>
            <span>O que posso fazer?</span>
        </button>
        <button class="menu-item" onclick="mostrarAtalhos()">
            <span>‚å®Ô∏è</span>
            <span>Atalhos de Teclado</span>
        </button>
    </nav>

    <!-- Tela de Boas-Vindas -->
<div id="tela-boas-vindas" class="modal-overlay">
    <div class="card-aviso boas-vindas">
        <img src="https://i.imgur.com/ivFEqQU.png" 
             width="110" 
             alt="Logo Cici"
             class="logo-boas-vindas">

        <h1 class="titulo-boas-vindas">üå∏ ùë∫ùíÜùíèùíÇ ‚úß</h1>

        <p class="subtitulo-forte">Tecnologia com alma gentil</p>
        <p class="subtitulo">Chat ‚Ä¢ An√°lise ‚Ä¢ C√≥digo ‚Ä¢ Imagens ‚Ä¢ Documentos</p>

        <button class="btn-grande" onclick="irParaAviso()">Come√ßar Agora</button>
    </div>
</div>

    <!-- Tela de Avisos -->
<div id="tela-aviso" class="modal-overlay oculto">
    <div class="card-aviso">
        <h2 class="aviso-titulo">‚ö†Ô∏è Informa√ß√µes Importantes</h2>

        <div class="aviso-lista">
            <p><strong>‚úì</strong> Sou uma assistente IA em desenvolvimento</p>
            <p><strong>‚úì</strong> Posso cometer erros ‚Äî verifique informa√ß√µes cr√≠ticas</p>
            <p><strong>‚úì</strong> N√£o compartilhe senhas ou dados banc√°rios</p>
            <p><strong>‚úì</strong> Suas conversas s√£o salvas localmente</p>
            <p><strong>‚úì</strong> Posso analisar documentos(beta), gerar c√≥digo e muito mais</p>
        </div>

        <button class="btn-grande" onclick="irParaChat()">Entendi e Aceito</button>

        <div class="aviso-links">
            <a href="https://termos.orpheostudio.com.br" target="_blank">Termos de Uso</a> |
            <a href="https://politicas.orpheostudio.com.br" target="_blank">Pol√≠tica de Privacidade</a>
        </div>
    </div>
</div>

    <!-- Aplica√ß√£o Principal -->
<div id="tela-app" class="oculto" style="display:flex; flex-direction:column; height:100%">
    <header class="app-header">
        
        <button class="menu-btn" onclick="abrirMenu()" aria-label="Abrir menu">
            <img src="https://i.imgur.com/6hl6JoA.png" alt="Menu" class="icone-menu">
        </button>

        <div class="logo-area">
            <img src="https://i.imgur.com/ivFEqQU.png" alt="Sena" class="logo">
        </div>

        <button class="header-action sena-btn" 
                onclick="novaConversa()" 
                aria-label="Nova conversa" 
                title="Nova conversa">
            <img src="https://i.imgur.com/FsXkN6B.png" alt="Nova conversa" class="icone-header">
        </button>

    </header>

    <div id="chat-container" role="main" aria-live="polite" aria-label="√Årea de conversa"></div>

    <div class="sugestoes-container">
        <div class="sugestoes-scroll" id="chips-sugestoes">
            <button class="chip" onclick="usarChip('Explique de forma simples:')">
                <span>üéØ</span> Explica√ß√£o Simples
            </button>
            <button class="chip" onclick="usarChip('Crie um c√≥digo em Python para:')">
                <span>üíª</span> Gerar C√≥digo
            </button>
            <button class="chip" onclick="usarChip('Analise este documento:')">
                <span>üìÑ</span> Analisar Documento
            </button>
            <button class="chip" onclick="usarChip('Resuma em t√≥picos:')">
                <span>üìù</span> Resumir
            </button>
            <button class="chip" onclick="usarChip('Traduza para o ingl√™s:')">
                <span>üåç</span> Traduzir
            </button>
            <button class="chip" onclick="usarChip('Me ajude com matem√°tica:')">
                <span>üî¢</span> Matem√°tica
            </button>
        </div>
    </div>
</div>

        <footer>
    <div class="input-tools" id="toolsBar">
        <button class="tool-btn" onclick="ativarModoContexto('criativo')" title="Modo criativo">
            <span>‚ú®</span> Criativo
        </button>
        <button class="tool-btn" onclick="ativarModoContexto('preciso')" title="Modo preciso">
            <span>üéØ</span> Preciso
        </button>
        <button class="tool-btn" onclick="ativarModoContexto('codigo')" title="Especialista em c√≥digo">
            <span>üíª</span> C√≥digo
        </button>
        <button class="tool-btn" onclick="ativarModoContexto('ensino')" title="Modo professor">
            <span>üéì</span> Ensino
        </button>
        <button class="tool-btn" onclick="ativarModoContexto('analise')" title="An√°lise profunda">
            <span>üî¨</span> An√°lise
        </button>
    </div>

    <div class="input-wrapper">
    <div class="input-actions">
        <button id="btn-mic" onclick="ativarMicrofone()" aria-label="Ativar microfone" title="Falar">üé§</button>
        <button id="btn-attach" onclick="anexarArquivo()" aria-label="Anexar arquivo" title="Anexar">üìé</button>
    </div>
</div>

        <<div class="input-area">
    <div class="input-container">
        <textarea id="entradaUsuario"
                  placeholder="Digite sua mensagem... (Shift+Enter para nova linha)"
                  rows="1"></textarea>

        <span class="input-contador" id="contador-chars">0/4000</span>
    </div>

    <button class="btn-send" id="btn-enviar" onclick="enviarMensagem()">
        Enviar
    </button>
    </div>
</footer>
    </div>

    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple>
    <div id="toast-container"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const CONFIG = {
            MISTRAL_API_KEY: 'NFuAj8PYUPcaf6tA1BjbyXuIeSjSA4sW',
            SUPABASE_URL: 'https://onyhbarnwvoqpwveyvhc.supabase.co',
            SUPABASE_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9ueWhiYXJud3ZvcXB3dmV5dmhjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc1OTY0NDQsImV4cCI6MjA3MzE3MjQ0NH0.2zqN73ZxkqxlWLp49Kmrg1CUau0YAi7dee2EIyhodoI',
            MAX_HISTORICO: 15,
            MAX_CHARS: 4000,
            VELOCIDADE_VOZ_PADRAO: 1.0,
            MODELOS_DISPONIVEIS: ['mistral-tiny', 'mistral-small', 'mistral-medium']
        };

        let estado = {
            somAtivado: false,
            velocidadeVoz: CONFIG.VELOCIDADE_VOZ_PADRAO,
            tamanhoFonte: 16,
            temaEscuro: false,
            altoContraste: false,
            leituraFacilitada: false,
            conversaAtual: [],
            aguardandoResposta: false,
            modoContexto: 'normal',
            arquivosAnexados: []
        };

        let supabase = null;

const urlValida = CONFIG.SUPABASE_URL && CONFIG.SUPABASE_URL !== 'SUA_URL_SUPABASE_AQUI';
const keyValida = CONFIG.SUPABASE_KEY && CONFIG.SUPABASE_KEY !== 'SUA_CHAVE_SUPABASE_AQUI';

if (urlValida && keyValida) {
    supabase = window.supabase.createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_KEY
    );
} else {
    console.warn("‚ö†Ô∏è Supabase n√£o configurado. Defina SUPABASE_URL e SUPABASE_KEY em CONFIG.");
}

        marked.setOptions({ 
            breaks: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // ===== NAVEGA√á√ÉO (DEVE ESTAR NO IN√çCIO) =====
        function irParaAviso() {
            document.getElementById('tela-boas-vindas').classList.add('oculto');
            document.getElementById('tela-aviso').classList.remove('oculto');
        }

        function irParaChat() {
            document.getElementById('tela-aviso').classList.add('oculto');
            document.getElementById('tela-app').classList.remove('oculto');
            
            const chat = document.getElementById('chat-container');
            if (chat.children.length === 0) {
                setTimeout(() => mostrarMensagemBoasVindas(), 300);
            }
        }

        function mostrarMensagemBoasVindas() {
    const mensagem = `# üå∏ Ol√°! Eu sou a **Sena**, sua assistente em desenvolvimento.

Aqui vai um resumo r√°pido do que eu consigo fazer por voc√™:

## üí¨ Conversa√ß√£o Natural
- Respostas claras e diretas
- Capacidade de manter contexto
- Explica√ß√µes f√°ceis at√© quando o assunto tenta complicar

## üíª Programa√ß√£o
- Gera√ß√£o de c√≥digo em m√∫ltiplas linguagens
- Explica√ß√µes t√©cnicas sem enrola√ß√£o
- Corre√ß√£o e otimiza√ß√£o de scripts

## üìÑ Documentos (Beta, pode haver erros)
- An√°lise de textos, PDFs e imagens
- Resumos enxutos ou completos
- Extra√ß√£o de informa√ß√µes relevantes

## üé® Criatividade
- Constru√ß√£o de hist√≥rias, poemas e roteiros
- Desenvolvimento de ideias novas
- Suporte criativo para qualquer projeto

## üî¨ An√°lises
- Compara√ß√µes inteligentes
- Racioc√≠nio detalhado
- Solu√ß√µes para problemas complexos

## üåç Idiomas
- Tradu√ß√µes naturais
- Explica√ß√µes gramaticais
- Ajuda no aprendizado de outros idiomas

Pronto para come√ßar?`;

            adicionarMensagem(mensagem, 'cici', false);
        }

        function abrirMenu() {
            document.getElementById('side-menu').classList.add('aberto');
            document.getElementById('overlay-menu').classList.add('aberto');
            document.body.style.overflow = 'hidden';
        }

        function fecharMenu() {
            document.getElementById('side-menu').classList.remove('aberto');
            document.getElementById('overlay-menu').classList.remove('aberto');
            document.body.style.overflow = '';
        }

        function novaConversa() {
            if (estado.conversaAtual.length === 0) {
                mostrarToast('J√° est√° em uma conversa nova', 'info');
                return;
            }
            if (confirm('Deseja iniciar uma nova conversa? A conversa atual ser√° salva.')) {
                const timestamp = Date.now();
                localStorage.setItem(`ciciChat_${timestamp}`, JSON.stringify(estado.conversaAtual));
                limparChat();
                setTimeout(() => mostrarMensagemBoasVindas(), 300);
                mostrarToast('Nova conversa iniciada!', 'sucesso');
            }
        }

        // ===== INICIALIZA√á√ÉO =====
        window.onload = () => {
            carregarConfiguracoes();
            carregarHistorico();
            configurarEventos();
            aplicarConfiguracoes();
            verificarSuporteFuncionalidades();
        };

        function carregarConfiguracoes() {
            const configs = JSON.parse(localStorage.getItem('ciciConfigs') || '{}');
            estado = { ...estado, ...configs };
            if (localStorage.getItem('altoContraste') === 'true') {
                estado.altoContraste = true;
            }
        }

        function salvarConfiguracoes() {
            localStorage.setItem('ciciConfigs', JSON.stringify(estado));
        }

        function aplicarConfiguracoes() {
            if (estado.temaEscuro) {
                document.body.classList.add('tema-escuro');
                document.getElementById('toggle-tema').classList.add('ativo');
                document.getElementById('icone-tema').textContent = '‚òÄÔ∏è';
                document.getElementById('texto-tema').textContent = 'Modo Claro';
            }
            if (estado.altoContraste) {
                document.body.classList.add('alto-contraste');
                document.getElementById('toggle-contraste').classList.add('ativo');
            }
            if (estado.leituraFacilitada) {
                document.body.classList.add('leitura-facilitada');
                document.getElementById('toggle-leitura').classList.add('ativo');
            }
            if (estado.somAtivado) {
                document.getElementById('toggle-som').classList.add('ativo');
                document.getElementById('icone-som').textContent = 'üîä';
                document.getElementById('texto-som').textContent = 'Desativar Voz';
            }
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
        }

        function configurarEventos() {
            const input = document.getElementById('entradaUsuario');
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensagem();
                }
            });
            
            input.addEventListener('input', () => {
                autoResizeTextarea(input);
                const contador = document.getElementById('contador-chars');
                contador.textContent = `${input.value.length}/${CONFIG.MAX_CHARS}`;
                if (input.value.length > CONFIG.MAX_CHARS * 0.9) {
                    contador.style.color = 'var(--danger)';
                } else {
                    contador.style.color = 'var(--text-secondary)';
                }
            });

            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    limparChat();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    exportarConversa();
                }
                if (e.key === 'Escape') {
                    fecharMenu();
                }
            });

            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                fileInput.addEventListener('change', processarArquivos);
            }
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function verificarSuporteFuncionalidades() {
            const temReconhecimentoVoz = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
            if (!temReconhecimentoVoz) {
                const btnMic = document.getElementById('btn-mic');
                if (btnMic) btnMic.style.display = 'none';
            }
        }

        // ===== NAVEGA√á√ÉO (REMOVIDO DUPLICADO) =====
        
        // ===== APAR√äNCIA =====
        function alternarTemaEscuro() {
            estado.temaEscuro = !estado.temaEscuro;
            document.body.classList.toggle('tema-escuro');
            const toggle = document.getElementById('toggle-tema');
            const icone = document.getElementById('icone-tema');
            const texto = document.getElementById('texto-tema');
            if (estado.temaEscuro) {
                toggle.classList.add('ativo');
                icone.textContent = '‚òÄÔ∏è';
                texto.textContent = 'Modo Claro';
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üåô';
                texto.textContent = 'Modo Escuro';
            }
            salvarConfiguracoes();
            mostrarToast('Tema alterado!', 'sucesso');
        }

        function alternarContraste() {
            estado.altoContraste = !estado.altoContraste;
            document.body.classList.toggle('alto-contraste');
            document.getElementById('toggle-contraste').classList.toggle('ativo');
            localStorage.setItem('altoContraste', estado.altoContraste);
            salvarConfiguracoes();
            mostrarToast('Alto contraste ' + (estado.altoContraste ? 'ativado' : 'desativado'), 'sucesso');
        }

        function alternarLeituraFacilitada() {
            estado.leituraFacilitada = !estado.leituraFacilitada;
            document.body.classList.toggle('leitura-facilitada');
            document.getElementById('toggle-leitura').classList.toggle('ativo');
            salvarConfiguracoes();
            mostrarToast('Leitura facilitada ' + (estado.leituraFacilitada ? 'ativada' : 'desativada'), 'sucesso');
        }

        function ajustarFonte(incremento) {
            estado.tamanhoFonte = Math.max(12, Math.min(28, estado.tamanhoFonte + incremento));
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
            salvarConfiguracoes();
            mostrarToast(`Tamanho: ${estado.tamanhoFonte}px`, 'sucesso');
        }

        function resetarFonte() {
            estado.tamanhoFonte = 16;
            document.documentElement.style.fontSize = '16px';
            salvarConfiguracoes();
            mostrarToast('Tamanho padr√£o restaurado', 'sucesso');
        }

        // ===== √ÅUDIO =====
        function alternarSom() {
            estado.somAtivado = !estado.somAtivado;
            const toggle = document.getElementById('toggle-som');
            const icone = document.getElementById('icone-som');
            const texto = document.getElementById('texto-som');
            if (estado.somAtivado) {
                toggle.classList.add('ativo');
                icone.textContent = 'üîä';
                texto.textContent = 'Desativar Voz';
                falar('Voz ativada com sucesso!');
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üîá';
                texto.textContent = 'Ativar Voz';
                window.speechSynthesis.cancel();
            }
            salvarConfiguracoes();
        }

        function ajustarVelocidadeVoz(incremento) {
            estado.velocidadeVoz = Math.max(0.5, Math.min(2.0, estado.velocidadeVoz + incremento));
            salvarConfiguracoes();
            const velocidadeTexto = estado.velocidadeVoz === 1.0 ? 'normal' : 
                                   estado.velocidadeVoz < 1.0 ? 'lenta' : 'r√°pida';
            mostrarToast(`Velocidade da voz: ${velocidadeTexto}`, 'sucesso');
            falar('Teste de velocidade da voz');
        }

        function falar(texto) {
            if (!estado.somAtivado || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const textoLimpo = texto.replace(/[*_#`]/g, '').replace(/<[^>]*>/g, '').replace(/\n+/g, '. ');
            const utterance = new SpeechSynthesisUtterance(textoLimpo);
            utterance.lang = 'pt-BR';
            utterance.rate = estado.velocidadeVoz;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function ativarMicrofone() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                mostrarToast('Seu navegador n√£o suporta reconhecimento de voz', 'erro');
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            const btnMic = document.getElementById('btn-mic');
            recognition.onstart = () => {
                btnMic.classList.add('ouvindo');
                mostrarToast('üé§ Estou ouvindo...', 'aviso');
            };
            recognition.onend = () => {
                btnMic.classList.remove('ouvindo');
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('entradaUsuario').value = transcript;
                document.getElementById('entradaUsuario').focus();
                autoResizeTextarea(document.getElementById('entradaUsuario'));
                mostrarToast('‚úì Texto capturado!', 'sucesso');
            };
            recognition.onerror = (event) => {
                btnMic.classList.remove('ouvindo');
                let mensagem = 'Erro ao capturar voz';
                if (event.error === 'no-speech') mensagem = 'Nenhuma fala detectada';
                else if (event.error === 'not-allowed') mensagem = 'Permiss√£o de microfone negada';
                mostrarToast(mensagem, 'erro');
            };
            try {
                recognition.start();
            } catch (e) {
                mostrarToast('Erro ao iniciar microfone', 'erro');
            }
        }

        // ===== MODOS DE CONTEXTO =====
        function ativarModoContexto(modo) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('ativo'));
            event.target.closest('.tool-btn').classList.add('ativo');
            estado.modoContexto = modo;
            
            const modos = {
                criativo: '‚ú® Modo Criativo ativado - Respostas mais imaginativas',
                preciso: 'üéØ Modo Preciso ativado - Respostas mais factuais',
                codigo: 'üíª Modo C√≥digo ativado - Especialista em programa√ß√£o',
                ensino: 'üéì Modo Ensino ativado - Explica√ß√µes did√°ticas',
                analise: 'üî¨ Modo An√°lise ativado - An√°lises profundas'
            };
            
            mostrarToast(modos[modo], 'sucesso');
        }

        // ===== ANEXAR ARQUIVOS =====
        function anexarArquivo() {
            document.getElementById('fileInput').click();
        }

        async function processarArquivos(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    mostrarToast(`Arquivo ${file.name} muito grande (m√°x 10MB)`, 'erro');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const conteudo = e.target.result;
                    const tipoArquivo = file.type.startsWith('image/') ? 'imagem' : 'documento';
                    
                    estado.arquivosAnexados.push({
                        nome: file.name,
                        tipo: tipoArquivo,
                        tamanho: file.size,
                        conteudo: conteudo
                    });
                    
                    mostrarArquivoAnexado(file.name, file.size, tipoArquivo);
                    mostrarToast(`‚úì ${file.name} anexado!`, 'sucesso');
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            }
            
            event.target.value = '';
        }

        function mostrarArquivoAnexado(nome, tamanho, tipo) {
            const chat = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'mensagem-wrapper usuario-wrapper';
            
            const icones = {
                'imagem': 'üñºÔ∏è',
                'documento': 'üìÑ'
            };
            
            wrapper.innerHTML = `
                <div class="mensagem usuario">
                    <div class="file-attachment">
                        <div class="file-icon">${icones[tipo]}</div>
                        <div class="file-info">
                            <div class="file-name">${nome}</div>
                            <div class="file-size">${formatarTamanho(tamanho)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
        }

        function formatarTamanho(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ===== ENVIAR MENSAGEM =====
        function usarChip(texto) {
            document.getElementById('entradaUsuario').value = texto + ' ';
            document.getElementById('entradaUsuario').focus();
            autoResizeTextarea(document.getElementById('entradaUsuario'));
        }

        async function enviarMensagem() {
            const input = document.getElementById('entradaUsuario');
            const texto = input.value.trim();
            
            if (!texto && estado.arquivosAnexados.length === 0) return;
            if (estado.aguardandoResposta) return;
            
            let mensagemCompleta = texto;
            
            if (estado.arquivosAnexados.length > 0) {
                mensagemCompleta += `\n\n[Arquivos anexados: ${estado.arquivosAnexados.map(a => a.nome).join(', ')}]`;
            }
            
            adicionarMensagem(mensagemCompleta, 'usuario', true);
            input.value = '';
            autoResizeTextarea(input);
            document.getElementById('contador-chars').textContent = '0/4000';
            
            estado.aguardandoResposta = true;
            document.getElementById('btn-enviar').disabled = true;
            
            mostrarIndicadorDigitacao();
            
            try {
                const resposta = await obterRespostaIA(mensagemCompleta);
                removerIndicadorDigitacao();
                adicionarMensagem(resposta, 'cici', true);
                
                if (estado.somAtivado) {
                    falar(resposta);
                }
            } catch (erro) {
                removerIndicadorDigitacao();
                adicionarMensagem('Desculpe, ocorreu um erro ao processar sua mensagem. Por favor, tente novamente.', 'cici', false);
                mostrarToast('Erro ao comunicar com a IA', 'erro');
                console.error('Erro:', erro);
            } finally {
                estado.aguardandoResposta = false;
                document.getElementById('btn-enviar').disabled = false;
                estado.arquivosAnexados = [];
            }
        }

        function mostrarIndicadorDigitacao() {
            const chat = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'mensagem-wrapper cici-wrapper';
            wrapper.id = 'indicador-digitacao';
            wrapper.innerHTML = `
                <div class="mensagem cici">
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
            `;
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
        }

        function removerIndicadorDigitacao() {
            const indicador = document.getElementById('indicador-digitacao');
            if (indicador) indicador.remove();
        }

        function adicionarMensagem(texto, remetente, salvar = true) {
            const chat = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            wrapper.className = `mensagem-wrapper ${remetente}-wrapper`;
            
            const agora = new Date();
            const hora = agora.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            
            const mensagemDiv = document.createElement('div');
            mensagemDiv.className = `mensagem ${remetente}`;
            
            if (remetente === 'cici') {
                mensagemDiv.innerHTML = marked.parse(texto);
                
                // Adicionar bot√µes de copiar para blocos de c√≥digo
                mensagemDiv.querySelectorAll('pre code').forEach((block) => {
                    const pre = block.parentElement;
                    const wrapper = document.createElement('div');
                    wrapper.style.position = 'relative';
                    
                    const header = document.createElement('div');
                    header.className = 'code-header';
                    
                    const language = block.className.replace('language-', '').replace('hljs', '').trim() || 'code';
                    header.innerHTML = `
                        <span class="code-language">${language}</span>
                        <button class="code-copy-btn" onclick="copiarCodigo(this)">üìã Copiar</button>
                    `;
                    
                    pre.parentNode.insertBefore(wrapper, pre);
                    wrapper.appendChild(header);
                    wrapper.appendChild(pre);
                });
            } else {
                mensagemDiv.textContent = texto;
            }
            
            const horaDiv = document.createElement('div');
            horaDiv.className = 'mensagem-hora';
            horaDiv.textContent = hora;
            
            wrapper.appendChild(mensagemDiv);
            wrapper.appendChild(horaDiv);
            
            if (remetente === 'cici') {
                const acoesDiv = document.createElement('div');
                acoesDiv.className = 'mensagem-acoes';
                acoesDiv.innerHTML = `
                    <button class="btn-acao" onclick="copiarMensagem(this)">
                        <span>üìã</span> Copiar
                    </button>
                    <button class="btn-acao" onclick="compartilharMensagem(this)">
                        <span>üì§</span> Compartilhar
                    </button>
                    ${estado.somAtivado ? `
                        <button class="btn-acao" onclick="repetirAudio(this)">
                            <span>üîä</span> Repetir
                        </button>
                    ` : ''}
                `;
                wrapper.appendChild(acoesDiv);
            }
            
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
            
            if (salvar) {
                estado.conversaAtual.push({ texto, remetente, timestamp: Date.now() });
                salvarHistorico();
            }
        }

        function copiarCodigo(btn) {
            const pre = btn.closest('div').querySelector('pre code');
            const codigo = pre.textContent;
            navigator.clipboard.writeText(codigo).then(() => {
                const textoOriginal = btn.textContent;
                btn.textContent = '‚úì Copiado!';
                setTimeout(() => btn.textContent = textoOriginal, 2000);
                mostrarToast('C√≥digo copiado!', 'sucesso');
            });
        }

        function copiarMensagem(btn) {
            const mensagem = btn.closest('.mensagem-wrapper').querySelector('.mensagem');
            const texto = mensagem.textContent || mensagem.innerText;
            navigator.clipboard.writeText(texto).then(() => {
                mostrarToast('Mensagem copiada!', 'sucesso');
            });
        }

        function compartilharMensagem(btn) {
            const mensagem = btn.closest('.mensagem-wrapper').querySelector('.mensagem');
            const texto = mensagem.textContent || mensagem.innerText;
            
            if (navigator.share) {
                navigator.share({
                    title: 'Cici AI',
                    text: texto
                }).catch(() => {});
            } else {
                copiarMensagem(btn);
                mostrarToast('Texto copiado para compartilhar', 'sucesso');
            }
        }

        function repetirAudio(btn) {
            const mensagem = btn.closest('.mensagem-wrapper').querySelector('.mensagem');
            const texto = mensagem.textContent || mensagem.innerText;
            falar(texto);
        }

        // ===== API IA =====
        async function obterRespostaIA(mensagemUsuario) {
            const systemPrompt = getSystemPromptPorModo(estado.modoContexto);
            
            const mensagens = [
                { role: 'system', content: systemPrompt },
                ...estado.conversaAtual.slice(-CONFIG.MAX_HISTORICO).map(m => ({
                    role: m.remetente === 'usuario' ? 'user' : 'assistant',
                    content: m.texto
                })),
                { role: 'user', content: mensagemUsuario }
            ];

            const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${CONFIG.MISTRAL_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'mistral-small-latest',
                    messages: mensagens,
                    temperature: estado.modoContexto === 'criativo' ? 0.9 : 0.7,
                    max_tokens: 2000
                })
            });

            if (!response.ok) {
                throw new Error(`Erro na API: ${response.status}`);
            }

            const data = await response.json();
            return data.choices[0].message.content;
        }

        function getSystemPromptPorModo(modo) {
            const prompts = {
                normal: 'Voc√™ √© Sena, uma assistente multifuncional avan√ßada. Seja prestativa, clara e objetiva.',
                criativo: 'Voc√™ √© Hanabi no modo criativo. Seja imaginativa, use met√°foras e analogias interessantes.',
                preciso: 'Voc√™ √© Sion no modo preciso. Seja factual, concisa e baseie suas respostas em informa√ß√µes verific√°veis.',
                codigo: 'Voc√™ √© Orion, especialista em programa√ß√£o. Forne√ßa c√≥digo limpo, bem comentado e explique suas solu√ß√µes.',
                ensino: 'Voc√™ √© Cici no modo professor. Explique conceitos de forma did√°tica, use exemplos e verifique o entendimento.',
                analise: 'Voc√™ √© Codex no modo an√°lise. Fa√ßa an√°lises profundas, considere m√∫ltiplas perspectivas e forne√ßa insights detalhados.'
            };
            return prompts[modo] || prompts.normal;
        }

        // ===== HIST√ìRICO =====
        function salvarHistorico() {
            try {
                localStorage.setItem('ciciHistorico', JSON.stringify(estado.conversaAtual));
            } catch (e) {
                console.error('Erro ao salvar hist√≥rico:', e);
            }
        }

        function carregarHistorico() {
            try {
                const historico = localStorage.getItem('ciciHistorico');
                if (historico) {
                    estado.conversaAtual = JSON.parse(historico);
                    estado.conversaAtual.forEach(msg => {
                        adicionarMensagem(msg.texto, msg.remetente, false);
                    });
                }
            } catch (e) {
                console.error('Erro ao carregar hist√≥rico:', e);
            }
        }

        function limparChat() {
            if (confirm('Deseja realmente limpar toda a conversa?')) {
                document.getElementById('chat-container').innerHTML = '';
                estado.conversaAtual = [];
                salvarHistorico();
                mostrarToast('Conversa limpa!', 'sucesso');
            }
        }

        // ===== EXPORTAR E COMPARTILHAR =====
        function exportarConversa() {
            if (estado.conversaAtual.length === 0) {
                mostrarToast('Nenhuma conversa para exportar', 'aviso');
                return;
            }
            
            let texto = '=== CONVERSA Sena ===\n\n';
            estado.conversaAtual.forEach(msg => {
                const remetente = msg.remetente === 'usuario' ? 'VOC√ä' : 'Sena';
                const data = new Date(msg.timestamp).toLocaleString('pt-BR');
                texto += `[${data}] ${remetente}:\n${msg.texto}\n\n`;
            });
            
            const blob = new Blob([texto], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `cici-conversa-${Date.now()}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            mostrarToast('Conversa exportada!', 'sucesso');
        }

        function compartilharConversa() {
            if (estado.conversaAtual.length === 0) {
                mostrarToast('Nenhuma conversa para compartilhar', 'aviso');
                return;
            }
            
            let texto = 'Conversa Sena:\n\n';
            estado.conversaAtual.slice(-5).forEach(msg => {
                const remetente = msg.remetente === 'usuario' ? 'Eu' : 'Sena';
                texto += `${remetente}: ${msg.texto}\n\n`;
            });
            
            if (navigator.share) {
                navigator.share({
                    title: 'Conversa Sena',
                    text: texto
                }).catch(() => {});
            } else {
                navigator.clipboard.writeText(texto).then(() => {
                    mostrarToast('Conversa copiada!', 'sucesso');
                });
            }
        }

        function imprimirConversa() {
            if (estado.conversaAtual.length === 0) {
                mostrarToast('Nenhuma conversa para imprimir', 'aviso');
                return;
            }
            window.print();
        }

        // ===== AJUDA =====
        function mostrarAjuda() {
            const ajuda = `# üìö Como Usar a Sena

## üí¨ Conversa√ß√£o
- Digite sua mensagem e pressione Enter (Shift+Enter para nova linha)
- Use o microfone üé§ para falar sua mensagem
- Anexe arquivos üìé para an√°lise

## ‚å®Ô∏è Atalhos de Teclado
- **Ctrl/Cmd + K**: Focar no campo de mensagem
- **Ctrl/Cmd + L**: Limpar conversa
- **Ctrl/Cmd + S**: Salvar conversa
- **Esc**: Fechar menu

## üé® Modos de Contexto
- **Criativo**: Respostas imaginativas
- **Preciso**: Informa√ß√µes factuais
- **C√≥digo**: Programa√ß√£o especializada
- **Ensino**: Explica√ß√µes did√°ticas
- **An√°lise**: An√°lises profundas

## üì± Recursos
- Anexar documentos e imagens
- Reconhecimento de voz
- S√≠ntese de voz
- Alto contraste
- Leitura facilitada
- Exportar conversas

Use o menu ‚ò∞ para acessar todas as configura√ß√µes!`;

            adicionarMensagem(ajuda, 'cici', false);
            fecharMenu();
        }

        function mostrarCapacidades() {
            const capacidades = `# üöÄ Capacidades da Sena

## üíª Programa√ß√£o
- Gero c√≥digo em Python, JavaScript, Java, C++, e mais
- Depuro e explico c√≥digo existente
- Crio algoritmos e estruturas de dados
- Ajudo com frameworks e bibliotecas

## üìÑ Documentos
- Analiso PDFs e documentos de texto
- Resumo conte√∫dos longos
- Extraio informa√ß√µes espec√≠ficas
- Comparo documentos

## üåç Idiomas
- Traduzo entre v√°rios idiomas
- Explico gram√°tica e vocabul√°rio
- Corrijo textos
- Ensino pron√∫ncia

## üî¨ An√°lise
- Analiso dados e estat√≠sticas
- Resolvo problemas matem√°ticos
- Fa√ßo an√°lises cr√≠ticas
- Comparo informa√ß√µes

## üé® Criatividade
- Escrevo hist√≥rias e poemas
- Crio roteiros e di√°logos
- Gero ideias criativas
- Ajudo com brainstorming

## üìö Educa√ß√£o
- Explico conceitos complexos
- Crio exerc√≠cios e exemplos
- Auxilio em trabalhos escolares
- Preparo para provas

Experimente! Estou aqui para ajudar! üòä`;

            adicionarMensagem(capacidades, 'sena', false);
            fecharMenu();
        }

        function mostrarAtalhos() {
            const atalhos = `# ‚å®Ô∏è Atalhos de Teclado

## Navega√ß√£o
- **Ctrl/Cmd + K**: Focar no campo de mensagem
- **Enter**: Enviar mensagem
- **Shift + Enter**: Nova linha
- **Esc**: Fechar menu lateral

## A√ß√µes
- **Ctrl/Cmd + L**: Limpar conversa
- **Ctrl/Cmd + S**: Salvar/Exportar conversa
- **Ctrl/Cmd + N**: Nova conversa

## Dicas
- Use as sugest√µes r√°pidas (chips) para come√ßar
- Experimente os diferentes modos de contexto
- Anexe arquivos para an√°lise mais completa
- Ative o microfone para ditado por voz`;

            adicionarMensagem(atalhos, 'cici', false);
            fecharMenu();
        }

        // ===== TOAST =====
        function mostrarToast(mensagem, tipo = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${tipo}`;
            
            const icones = {
                sucesso: '‚úì',
                erro: '‚úï',
                aviso: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            toast.innerHTML = `
                <span style="font-size:1.4em">${icones[tipo]}</span>
                <span>${mensagem}</span>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('mostrar'), 10);
            
            setTimeout(() => {
                toast.classList.remove('mostrar');
                setTimeout(() => toast.remove(), 400);
            }, 3000);
        }

        // Service Worker (PWA)
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js').catch(() => {});
            });
        }
    </script>
</body>
</html>