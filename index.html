<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>Cici AI - Assistente Multifuncional</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="description" content="Assistente AI multifuncional com chat, an√°lise de documentos, gera√ß√£o de imagens, c√≥digo e muito mais">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4712/4712027.png">

    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    
    <script type="text/javascript">
        (function(c,l,a,r,i,t,y){
            c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};
            t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;
            y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);
        })(window, document, "clarity", "script", "SEU_ID_DO_CLARITY"); 
    </script>

    <style>
        :root {
            --primary: #6c5ce7; 
            --primary-dark: #4834d4;
            --primary-light: #a29bfe;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --info: #0984e3;
            --bg-app: #f5f6fa;
            --bg-chat: #ffffff;
            --bg-card: #ffffff;
            --text-main: #2d3436;
            --text-secondary: #636e72;
            --cici-bubble: linear-gradient(135deg, #a29bfe 0%, #6c5ce7 100%);
            --cici-text: #ffffff;
            --user-bubble: #fab1a0;
            --user-text: #2d3436;
            --border-color: #dfe6e9;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
            --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 30px rgba(0,0,0,0.12);
            --menu-bg: rgba(255, 255, 255, 0.98);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.alto-contraste {
            --primary: #000000;
            --primary-dark: #333;
            --bg-app: #000000;
            --bg-chat: #000000;
            --bg-card: #1a1a1a;
            --text-main: #ffff00;
            --text-secondary: #ffff00;
            --cici-bubble: #333333;
            --cici-text: #ffff00;
            --user-bubble: #ffff00;
            --user-text: #000000;
            --menu-bg: #1a1a1a;
            --border-color: #ffff00;
            --shadow-sm: 0 0 0 2px #ffff00;
            --shadow-md: 0 0 0 2px #ffff00;
            --shadow-lg: 0 0 0 3px #ffff00;
        }

        body.tema-escuro:not(.alto-contraste) {
            --primary: #a29bfe;
            --primary-dark: #6c5ce7;
            --bg-app: #1e1e1e;
            --bg-chat: #2d2d2d;
            --bg-card: #2d2d2d;
            --text-main: #e0e0e0;
            --text-secondary: #b0b0b0;
            --cici-bubble: linear-gradient(135deg, #6c5ce7 0%, #4834d4 100%);
            --user-bubble: #fab1a0;
            --border-color: #444;
            --menu-bg: rgba(45, 45, 45, 0.98);
        }

        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-app);
            color: var(--text-main);
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-size: 16px;
            overflow: hidden;
            transition: var(--transition);
        }

        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: var(--primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 1000;
        }
        .skip-link:focus { top: 0; }

        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0,0,0,0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Markdown Styling */
        .mensagem p { margin: 8px 0; line-height: 1.6; }
        .mensagem p:first-child { margin-top: 0; }
        .mensagem p:last-child { margin-bottom: 0; }
        .mensagem ul, .mensagem ol { margin: 10px 0; padding-left: 24px; line-height: 1.8; }
        .mensagem li { margin: 6px 0; }
        .mensagem strong { font-weight: 800; color: var(--primary); }
        .mensagem em { font-style: italic; opacity: 0.9; }
        .mensagem code:not(.hljs) { 
            background: rgba(0,0,0,0.1); 
            padding: 2px 6px; 
            border-radius: 4px; 
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }
        .mensagem pre {
            background: #1e1e1e;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }
        .mensagem pre code {
            background: none;
            padding: 0;
            color: #e0e0e0;
        }
        .mensagem a { 
            color: var(--primary); 
            text-decoration: underline;
            font-weight: 600;
        }
        .mensagem h1, .mensagem h2, .mensagem h3 {
            margin: 16px 0 8px 0;
            font-weight: 800;
        }
        .mensagem blockquote {
            border-left: 4px solid var(--primary);
            padding-left: 16px;
            margin: 12px 0;
            opacity: 0.9;
        }
        .mensagem table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }
        .mensagem table th,
        .mensagem table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }
        .mensagem table th {
            background: var(--primary);
            color: white;
            font-weight: bold;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            min-height: 65px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: var(--shadow-md);
            z-index: 20;
            position: relative;
        }

        .menu-btn, .header-action {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .menu-btn:hover, .header-action:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        .logo-area {
            font-size: 1.4em;
            font-weight: 800;
            display: flex;
            gap: 8px;
            align-items: center;
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            background: var(--success);
            border-radius: 50%;
            animation: pulse-dot 2s infinite;
        }

        @keyframes pulse-dot {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Menu Lateral */
        #overlay-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 25;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            backdrop-filter: blur(2px);
        }
        #overlay-menu.aberto {
            opacity: 1;
            pointer-events: all;
        }

        #side-menu {
            position: fixed;
            top: 0;
            left: -340px;
            width: 320px;
            height: 100%;
            background: var(--menu-bg);
            z-index: 30;
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 24px;
            display: flex;
            flex-direction: column;
            gap: 8px;
            box-shadow: 5px 0 20px rgba(0,0,0,0.3);
            backdrop-filter: blur(20px);
            overflow-y: auto;
        }
        #side-menu.aberto { left: 0; }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 2px solid var(--border-color);
        }

        .menu-close {
            background: var(--danger);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .menu-item {
            background: none;
            border: 2px solid transparent;
            color: var(--text-main);
            padding: 14px 16px;
            text-align: left;
            font-size: 0.95em;
            font-weight: 600;
            border-radius: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: var(--transition);
        }
        .menu-item:hover {
            background-color: var(--primary);
            color: white;
            transform: translateX(4px);
        }

        .menu-titulo {
            font-size: 0.85em;
            font-weight: bold;
            margin: 16px 0 8px 0;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .menu-divider {
            height: 1px;
            background: var(--border-color);
            margin: 12px 0;
            opacity: 0.5;
        }

        .toggle-switch {
            width: 48px;
            height: 26px;
            background: var(--border-color);
            border-radius: 13px;
            position: relative;
            cursor: pointer;
            transition: var(--transition);
            margin-left: auto;
        }
        .toggle-switch.ativo {
            background: var(--success);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 3px;
            left: 3px;
            transition: var(--transition);
        }
        .toggle-switch.ativo::after {
            left: 25px;
        }

        /* Chat Area */
        #chat-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: var(--bg-chat);
            scroll-behavior: smooth;
        }

        #chat-container::-webkit-scrollbar { width: 8px; }
        #chat-container::-webkit-scrollbar-track { background: transparent; }
        #chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        .mensagem-wrapper {
            display: flex;
            flex-direction: column;
            max-width: 85%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .cici-wrapper { align-self: flex-start; }
        .usuario-wrapper { align-self: flex-end; align-items: flex-end; }

        .mensagem {
            padding: 16px 20px;
            border-radius: 18px;
            line-height: 1.6;
            box-shadow: var(--shadow-sm);
            word-wrap: break-word;
            position: relative;
        }

        .cici {
            background: var(--cici-bubble);
            color: var(--cici-text);
            border-bottom-left-radius: 4px;
        }

        .usuario {
            background-color: var(--user-bubble);
            color: var(--user-text);
            border-bottom-right-radius: 4px;
        }

        .mensagem-hora {
            font-size: 0.75em;
            opacity: 0.7;
            margin-top: 4px;
        }

        .mensagem-acoes {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .btn-acao {
            background: rgba(0,0,0,0.05);
            border: none;
            color: var(--text-secondary);
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            gap: 4px;
            align-items: center;
            padding: 6px 12px;
            border-radius: 8px;
            transition: var(--transition);
            font-weight: 600;
        }
        .btn-acao:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
        }

        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 16px 20px;
        }
        .typing-dot {
            width: 8px;
            height: 8px;
            background: var(--cici-text);
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; transform: scale(0.8); }
            30% { opacity: 1; transform: scale(1); }
        }

        /* Anexos e Cards Especiais */
        .file-attachment {
            background: rgba(0,0,0,0.05);
            padding: 12px;
            border-radius: 10px;
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 12px;
            border: 2px dashed var(--border-color);
        }

        .file-icon {
            font-size: 2em;
        }

        .file-info {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .file-size {
            font-size: 0.85em;
            opacity: 0.7;
        }

        .image-preview {
            max-width: 100%;
            border-radius: 12px;
            margin: 8px 0;
            cursor: pointer;
            transition: var(--transition);
        }

        .image-preview:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        /* Capabilities Cards */
        .capabilities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin: 16px 0;
        }

        .capability-card {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .capability-card:hover {
            border-color: var(--primary);
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .capability-icon {
            font-size: 2.5em;
            margin-bottom: 8px;
        }

        .capability-title {
            font-weight: 700;
            font-size: 0.9em;
            color: var(--text-main);
        }

        /* Sugest√µes */
        .sugestoes-container {
            padding: 12px 20px;
            background: var(--bg-chat);
            border-top: 1px solid var(--border-color);
        }

        .sugestoes-scroll {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: thin;
        }

        .chip {
            background: var(--bg-card);
            color: var(--text-main);
            padding: 10px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            white-space: nowrap;
            border: 2px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
        }
        .chip:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        /* Footer / Input */
        footer {
            background: var(--bg-chat);
            padding: 16px 20px 20px;
            border-top: 1px solid var(--border-color);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
        }

        .input-tools {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .tool-btn {
            background: var(--bg-card);
            border: 2px solid var(--border-color);
            color: var(--text-main);
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.85em;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            white-space: nowrap;
            transition: var(--transition);
            font-weight: 600;
        }

        .tool-btn:hover, .tool-btn.ativo {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: flex-end;
            position: relative;
        }

        .input-container {
            flex: 1;
            position: relative;
        }

        #entradaUsuario {
            width: 100%;
            padding: 14px 50px 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 1em;
            outline: none;
            font-family: inherit;
            background: var(--bg-card);
            color: var(--text-main);
            transition: var(--transition);
            resize: none;
            min-height: 52px;
            max-height: 120px;
        }
        #entradaUsuario:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1);
        }

        .input-contador {
            position: absolute;
            right: 16px;
            bottom: 16px;
            font-size: 0.75em;
            color: var(--text-secondary);
            pointer-events: none;
        }

        .input-actions {
            display: flex;
            gap: 8px;
        }

        #btn-mic, #btn-attach {
            background: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            color: white;
            width: 52px;
            height: 52px;
            min-width: 52px;
            border-radius: 50%;
            border: none;
            font-size: 1.3em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
        }

        #btn-attach {
            background: linear-gradient(135deg, #0984e3 0%, #74b9ff 100%);
        }

        #btn-mic:hover, #btn-attach:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-lg);
        }

        #btn-mic.ouvindo {
            background: linear-gradient(135deg, var(--success) 0%, #00b894 100%);
            animation: pulse 1.5s infinite;
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 0 28px;
            height: 52px;
            border-radius: 26px;
            border: none;
            font-weight: bold;
            cursor: pointer;
            box-shadow: var(--shadow-md);
            transition: var(--transition);
            font-size: 1em;
            white-space: nowrap;
        }
        .btn-send:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            z-index: 100;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            overflow-y: auto;
        }

        .card-aviso {
            background: rgba(255,255,255,0.15);
            padding: 40px 32px;
            border-radius: 24px;
            backdrop-filter: blur(20px);
            max-width: 500px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .card-aviso h1 { font-size: 2.5em; margin: 16px 0; }
        .card-aviso p {
            font-size: 1.1em;
            line-height: 1.6;
            opacity: 0.95;
            margin: 12px 0;
        }

        .btn-grande {
            background: white;
            color: var(--primary);
            padding: 16px 48px;
            border-radius: 30px;
            border: none;
            font-size: 1.2em;
            font-weight: bold;
            margin-top: 24px;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            transition: var(--transition);
        }
        .btn-grande:hover { transform: scale(1.05); }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bg-card);
            color: var(--text-main);
            padding: 16px 24px;
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 12px;
            min-width: 250px;
            max-width: 90%;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid var(--border-color);
        }
        .toast.mostrar {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        .toast.sucesso { border-color: var(--success); }
        .toast.erro { border-color: var(--danger); }
        .toast.aviso { border-color: var(--warning); }

        .oculto { display: none !important; }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .mensagem-wrapper { max-width: 90%; }
            .capabilities-grid { grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); }
        }

        @media (max-width: 480px) {
            header { padding: 0 12px; }
            #chat-container { padding: 12px; }
            footer { padding: 12px; }
        }

        body.leitura-facilitada {
            font-size: 20px;
        }
        body.leitura-facilitada .mensagem {
            line-height: 2;
            letter-spacing: 0.5px;
        }

        /* File Input Hidden */
        #fileInput {
            display: none;
        }

        /* Code Copy Button */
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #2d2d2d;
            padding: 8px 12px;
            border-radius: 8px 8px 0 0;
            margin-bottom: -12px;
        }

        .code-language {
            color: #aaa;
            font-size: 0.85em;
            font-weight: 600;
        }

        .code-copy-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 0.8em;
            cursor: pointer;
            transition: var(--transition);
        }

        .code-copy-btn:hover {
            background: var(--primary-dark);
        }
    </style>
</head>
<body>
    <a href="#chat-container" class="skip-link">Pular para o chat</a>

    <div id="overlay-menu" onclick="fecharMenu()"></div>

    <nav id="side-menu" role="navigation">
        <div class="menu-header">
            <h2 style="margin:0; font-size:1.3em;">‚öôÔ∏è Configura√ß√µes</h2>
            <button class="menu-close" onclick="fecharMenu()">‚úï</button>
        </div>

        <div class="menu-titulo">üé® Apar√™ncia</div>
        <button class="menu-item" onclick="alternarTemaEscuro()">
            <span id="icone-tema">üåô</span>
            <span id="texto-tema">Modo Escuro</span>
            <div class="toggle-switch" id="toggle-tema"></div>
        </button>
        <button class="menu-item" onclick="alternarContraste()">
            <span>üåì</span>
            <span>Alto Contraste</span>
            <div class="toggle-switch" id="toggle-contraste"></div>
        </button>
        <button class="menu-item" onclick="alternarLeituraFacilitada()">
            <span>üìñ</span>
            <span>Leitura Facilitada</span>
            <div class="toggle-switch" id="toggle-leitura"></div>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üî§ Tamanho do Texto</div>
        <button class="menu-item" onclick="ajustarFonte(2)">
            <span>üîç</span>
            <span>Aumentar Letra</span>
        </button>
        <button class="menu-item" onclick="ajustarFonte(-2)">
            <span>üîé</span>
            <span>Diminuir Letra</span>
        </button>
        <button class="menu-item" onclick="resetarFonte()">
            <span>‚Ü©Ô∏è</span>
            <span>Tamanho Padr√£o</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üîä √Åudio</div>
        <button class="menu-item" onclick="alternarSom()">
            <span id="icone-som">üîá</span>
            <span id="texto-som">Ativar Voz</span>
            <div class="toggle-switch" id="toggle-som"></div>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(-0.2)">
            <span>üê¢</span>
            <span>Voz Mais Lenta</span>
        </button>
        <button class="menu-item" onclick="ajustarVelocidadeVoz(0.2)">
            <span>üêá</span>
            <span>Voz Mais R√°pida</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">üìÇ A√ß√µes</div>
        <button class="menu-item" onclick="exportarConversa()">
            <span>üíæ</span>
            <span>Salvar Conversa</span>
        </button>
        <button class="menu-item" onclick="compartilharConversa()">
            <span>üì§</span>
            <span>Compartilhar</span>
        </button>
        <button class="menu-item" onclick="imprimirConversa()">
            <span>üñ®Ô∏è</span>
            <span>Imprimir</span>
        </button>
        <button class="menu-item" onclick="limparChat()" style="color: var(--danger);">
            <span>üóëÔ∏è</span>
            <span>Limpar Conversa</span>
        </button>

        <div class="menu-divider"></div>

        <div class="menu-titulo">‚ùì Ajuda</div>
        <button class="menu-item" onclick="mostrarAjuda()">
            <span>üìö</span>
            <span>Como Usar</span>
        </button>
        <button class="menu-item" onclick="mostrarCapacidades()">
            <span>üöÄ</span>
            <span>O que posso fazer?</span>
        </button>
        <button class="menu-item" onclick="mostrarAtalhos()">
            <span>‚å®Ô∏è</span>
            <span>Atalhos de Teclado</span>
        </button>
    </nav>

    <!-- Tela de Boas-Vindas -->
    <div id="tela-boas-vindas" class="modal-overlay">
        <div class="card-aviso">
            <img src="https://cdn-icons-png.flaticon.com/512/4712/4712027.png" 
                 width="100" 
                 alt="Logo Cici"
                 style="margin-bottom:20px; filter: drop-shadow(0 4px 8px rgba(0,0,0,0.2));">
            <h1>ü§ñ Cici AI</h1>
            <p style="font-size: 1.3em; font-weight: 700;">Assistente Multifuncional</p>
            <p>Chat ‚Ä¢ An√°lise ‚Ä¢ C√≥digo ‚Ä¢ Imagens ‚Ä¢ Documentos</p>
            <button class="btn-grande" onclick="irParaAviso()">Come√ßar Agora</button>
        </div>
    </div>

    <!-- Tela de Avisos -->
    <div id="tela-aviso" class="modal-overlay oculto">
        <div class="card-aviso">
            <h2 style="font-size: 2em; margin-bottom: 20px;">‚ö†Ô∏è Informa√ß√µes Importantes</h2>
            <div style="text-align: left; margin: 20px 0;">
                <p><strong>‚úì</strong> Sou uma assistente IA avan√ßada e multifuncional</p>
                <p><strong>‚úì</strong> Posso cometer erros - verifique informa√ß√µes cr√≠ticas</p>
                <p><strong>‚úì</strong> N√£o compartilhe senhas ou dados banc√°rios</p>
                <p><strong>‚úì</strong> Suas conversas s√£o salvas localmente</p>
                <p><strong>‚úì</strong> Posso analisar documentos, gerar c√≥digo e muito mais</p>
            </div>
            <button class="btn-grande" onclick="irParaChat()">Entendi e Aceito</button>
            <div style="margin-top: 24px; font-size: 0.9em; opacity: 0.9;">
                <a href="https://termos.orpheostudio.com.br" style="color:white" target="_blank">Termos de Uso</a> | 
                <a href="https://politicas.orpheostudio.com.br" style="color:white" target="_blank">Pol√≠tica de Privacidade</a>
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="tela-app" class="oculto" style="display:flex; flex-direction:column; height:100%">
        <header>
            <button class="menu-btn" onclick="abrirMenu()" aria-label="Abrir menu">‚ò∞</button>
            <div class="logo-area">
                <span>ü§ñ Cici AI</span>
                <span class="status-indicator" aria-label="Online"></span>
            </div>
            <button class="header-action" onclick="novaConversa()" aria-label="Nova conversa" title="Nova conversa">
                ‚ûï
            </button>
        </header>

        <div id="chat-container" role="main" aria-live="polite" aria-label="√Årea de conversa"></div>

        <div class="sugestoes-container">
            <div class="sugestoes-scroll" id="chips-sugestoes">
                <button class="chip" onclick="usarChip('Explique de forma simples:')">
                    <span>üéØ</span> Explica√ß√£o Simples
                </button>
                <button class="chip" onclick="usarChip('Crie um c√≥digo em Python para:')">
                    <span>üíª</span> Gerar C√≥digo
                </button>
                <button class="chip" onclick="usarChip('Analise este documento:')">
                    <span>üìÑ</span> Analisar Documento
                </button>
                <button class="chip" onclick="usarChip('Resuma em t√≥picos:')">
                    <span>üìù</span> Resumir
                </button>
                <button class="chip" onclick="usarChip('Traduza para o ingl√™s:')">
                    <span>üåç</span> Traduzir
                </button>
                <button class="chip" onclick="usarChip('Me ajude com matem√°tica:')">
                    <span>üî¢</span> Matem√°tica
                </button>
            </div>
        </div>

        <footer>
            <div class="input-tools" id="toolsBar">
                <button class="tool-btn" onclick="ativarModoContexto('criativo')" title="Modo criativo">
                    <span>‚ú®</span> Criativo
                </button>
                <button class="tool-btn" onclick="ativarModoContexto('preciso')" title="Modo preciso">
                    <span>üéØ</span> Preciso
                </button>
                <button class="tool-btn" onclick="ativarModoContexto('codigo')" title="Especialista em c√≥digo">
                    <span>üíª</span> C√≥digo
                </button>
                <button class="tool-btn" onclick="ativarModoContexto('ensino')" title="Modo professor">
                    <span>üéì</span> Ensino
                </button>
                <button class="tool-btn" onclick="ativarModoContexto('analise')" title="An√°lise profunda">
                    <span>üî¨</span> An√°lise
                </button>
            </div>

            <div class="input-wrapper">
                <div class="input-actions">
                    <button id="btn-mic" onclick="ativarMicrofone()" aria-label="Ativar microfone" title="Falar">üé§</button>
                    <button id="btn-attach" onclick="anexarArquivo()" aria-label="Anexar arquivo" title="Anexar">üìé</button>
                </div>
                
                <div class="input-container">
                    <textarea id="entradaUsuario" 
                           placeholder="Digite sua mensagem... (Shift+Enter para nova linha)" 
                           aria-label="Campo de mensagem"
                           rows="1"></textarea>
                    <span class="input-contador" id="contador-chars">0/4000</span>
                </div>
                
                <button class="btn-send" 
                        onclick="enviarMensagem()" 
                        id="btn-enviar"
                        aria-label="Enviar mensagem">
                    Enviar
                </button>
            </div>
        </footer>
    </div>

    <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif" multiple>
    <div id="toast-container"></div>

    <script>
        // ===== CONFIGURA√á√ïES =====
        const CONFIG = {
            MISTRAL_API_KEY: 'SUA_CHAVE_API_MISTRAL_AQUI',
            SUPABASE_URL: 'SUA_URL_SUPABASE_AQUI',
            SUPABASE_KEY: 'SUA_CHAVE_ANON_SUPABASE_AQUI',
            MAX_HISTORICO: 15,
            MAX_CHARS: 4000,
            VELOCIDADE_VOZ_PADRAO: 1.0,
            MODELOS_DISPONIVEIS: ['mistral-tiny', 'mistral-small', 'mistral-medium']
        };

        let estado = {
            somAtivado: false,
            velocidadeVoz: CONFIG.VELOCIDADE_VOZ_PADRAO,
            tamanhoFonte: 16,
            temaEscuro: false,
            altoContraste: false,
            leituraFacilitada: false,
            conversaAtual: [],
            aguardandoResposta: false,
            modoContexto: 'normal',
            arquivosAnexados: []
        };

        let supabase = null;
        if (CONFIG.SUPABASE_URL !== 'SUA_URL_SUPABASE_AQUI') {
            supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
        }

        marked.setOptions({ 
            breaks: true,
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });

        // ===== INICIALIZA√á√ÉO =====
        window.onload = () => {
            carregarConfiguracoes();
            carregarHistorico();
            configurarEventos();
            aplicarConfiguracoes();
            verificarSuporteFuncionalidades();
        };

        function carregarConfiguracoes() {
            const configs = JSON.parse(localStorage.getItem('ciciConfigs') || '{}');
            estado = { ...estado, ...configs };
            if (localStorage.getItem('altoContraste') === 'true') {
                estado.altoContraste = true;
            }
        }

        function salvarConfiguracoes() {
            localStorage.setItem('ciciConfigs', JSON.stringify(estado));
        }

        function aplicarConfiguracoes() {
            if (estado.temaEscuro) {
                document.body.classList.add('tema-escuro');
                document.getElementById('toggle-tema').classList.add('ativo');
                document.getElementById('icone-tema').textContent = '‚òÄÔ∏è';
                document.getElementById('texto-tema').textContent = 'Modo Claro';
            }
            if (estado.altoContraste) {
                document.body.classList.add('alto-contraste');
                document.getElementById('toggle-contraste').classList.add('ativo');
            }
            if (estado.leituraFacilitada) {
                document.body.classList.add('leitura-facilitada');
                document.getElementById('toggle-leitura').classList.add('ativo');
            }
            if (estado.somAtivado) {
                document.getElementById('toggle-som').classList.add('ativo');
                document.getElementById('icone-som').textContent = 'üîä';
                document.getElementById('texto-som').textContent = 'Desativar Voz';
            }
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
        }

        function configurarEventos() {
            const input = document.getElementById('entradaUsuario');
            
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    enviarMensagem();
                }
            });
            
            input.addEventListener('input', () => {
                autoResizeTextarea(input);
                const contador = document.getElementById('contador-chars');
                contador.textContent = `${input.value.length}/${CONFIG.MAX_CHARS}`;
                if (input.value.length > CONFIG.MAX_CHARS * 0.9) {
                    contador.style.color = 'var(--danger)';
                } else {
                    contador.style.color = 'var(--text-secondary)';
                }
            });

            document.addEventListener('keydown', (e) => {
                if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                    e.preventDefault();
                    input.focus();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
                    e.preventDefault();
                    limparChat();
                }
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    exportarConversa();
                }
                if (e.key === 'Escape') {
                    fecharMenu();
                }
            });

            document.getElementById('fileInput').addEventListener('change', processarArquivos);
        }

        function autoResizeTextarea(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function verificarSuporteFuncionalidades() {
            const temReconhecimentoVoz = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
            if (!temReconhecimentoVoz) {
                document.getElementById('btn-mic').style.display = 'none';
            }
        }

        // ===== NAVEGA√á√ÉO =====
        function irParaAviso() {
            document.getElementById('tela-boas-vindas').classList.add('oculto');
            document.getElementById('tela-aviso').classList.remove('oculto');
        }

        function irParaChat() {
            document.getElementById('tela-aviso').classList.add('oculto');
            document.getElementById('tela-app').classList.remove('oculto');
            
            const chat = document.getElementById('chat-container');
            if (chat.children.length === 0) {
                setTimeout(() => mostrarMensagemBoasVindas(), 300);
            }
        }

        function mostrarMensagemBoasVindas() {
            const mensagem = `# üöÄ Ol√°! Eu sou a **Cici AI**

Sou uma assistente multifuncional avan√ßada. Veja o que posso fazer:

**üí¨ Conversa√ß√£o Natural**
- Respondo perguntas complexas
- Mantenho contexto da conversa
- Explico conceitos de forma clara

**üíª Programa√ß√£o**
- Gero c√≥digo em v√°rias linguagens
- Explico e depuro c√≥digo
- Crio algoritmos e solu√ß√µes

**üìÑ Documentos**
- Analiso PDFs, textos e imagens
- Resumo conte√∫dos
- Extraio informa√ß√µes importantes

**üé® Criatividade**
- Escrevo hist√≥rias e poemas
- Crio roteiros e ideias
- Ajudo com brainstorming

**üî¨ An√°lise**
- Fa√ßo an√°lises profundas
- Comparo informa√ß√µes
- Resolvo problemas complexos

**üåç Multil√≠ngue**
- Traduzo textos
- Ensino idiomas
- Explico gram√°tica

Como posso ajudar voc√™ hoje?`;

            adicionarMensagem(mensagem, 'cici', false);
        }

        function abrirMenu() {
            document.getElementById('side-menu').classList.add('aberto');
            document.getElementById('overlay-menu').classList.add('aberto');
            document.body.style.overflow = 'hidden';
        }

        function fecharMenu() {
            document.getElementById('side-menu').classList.remove('aberto');
            document.getElementById('overlay-menu').classList.remove('aberto');
            document.body.style.overflow = '';
        }

        function novaConversa() {
            if (estado.conversaAtual.length === 0) {
                mostrarToast('J√° est√° em uma conversa nova', 'info');
                return;
            }
            if (confirm('Deseja iniciar uma nova conversa? A conversa atual ser√° salva.')) {
                const timestamp = Date.now();
                localStorage.setItem(`ciciChat_${timestamp}`, JSON.stringify(estado.conversaAtual));
                limparChat();
                setTimeout(() => mostrarMensagemBoasVindas(), 300);
                mostrarToast('Nova conversa iniciada!', 'sucesso');
            }
        }

        // ===== APAR√äNCIA =====
        function alternarTemaEscuro() {
            estado.temaEscuro = !estado.temaEscuro;
            document.body.classList.toggle('tema-escuro');
            const toggle = document.getElementById('toggle-tema');
            const icone = document.getElementById('icone-tema');
            const texto = document.getElementById('texto-tema');
            if (estado.temaEscuro) {
                toggle.classList.add('ativo');
                icone.textContent = '‚òÄÔ∏è';
                texto.textContent = 'Modo Claro';
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üåô';
                texto.textContent = 'Modo Escuro';
            }
            salvarConfiguracoes();
            mostrarToast('Tema alterado!', 'sucesso');
        }

        function alternarContraste() {
            estado.altoContraste = !estado.altoContraste;
            document.body.classList.toggle('alto-contraste');
            document.getElementById('toggle-contraste').classList.toggle('ativo');
            localStorage.setItem('altoContraste', estado.altoContraste);
            salvarConfiguracoes();
            mostrarToast('Alto contraste ' + (estado.altoContraste ? 'ativado' : 'desativado'), 'sucesso');
        }

        function alternarLeituraFacilitada() {
            estado.leituraFacilitada = !estado.leituraFacilitada;
            document.body.classList.toggle('leitura-facilitada');
            document.getElementById('toggle-leitura').classList.toggle('ativo');
            salvarConfiguracoes();
            mostrarToast('Leitura facilitada ' + (estado.leituraFacilitada ? 'ativada' : 'desativada'), 'sucesso');
        }

        function ajustarFonte(incremento) {
            estado.tamanhoFonte = Math.max(12, Math.min(28, estado.tamanhoFonte + incremento));
            document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
            salvarConfiguracoes();
            mostrarToast(`Tamanho: ${estado.tamanhoFonte}px`, 'sucesso');
        }

        function resetarFonte() {
            estado.tamanhoFonte = 16;
            document.documentElement.style.fontSize = '16px';
            salvarConfiguracoes();
            mostrarToast('Tamanho padr√£o restaurado', 'sucesso');
        }

        // ===== √ÅUDIO =====
        function alternarSom() {
            estado.somAtivado = !estado.somAtivado;
            const toggle = document.getElementById('toggle-som');
            const icone = document.getElementById('icone-som');
            const texto = document.getElementById('texto-som');
            if (estado.somAtivado) {
                toggle.classList.add('ativo');
                icone.textContent = 'üîä';
                texto.textContent = 'Desativar Voz';
                falar('Voz ativada com sucesso!');
            } else {
                toggle.classList.remove('ativo');
                icone.textContent = 'üîá';
                texto.textContent = 'Ativar Voz';
                window.speechSynthesis.cancel();
            }
            salvarConfiguracoes();
        }

        function ajustarVelocidadeVoz(incremento) {
            estado.velocidadeVoz = Math.max(0.5, Math.min(2.0, estado.velocidadeVoz + incremento));
            salvarConfiguracoes();
            const velocidadeTexto = estado.velocidadeVoz === 1.0 ? 'normal' : 
                                   estado.velocidadeVoz < 1.0 ? 'lenta' : 'r√°pida';
            mostrarToast(`Velocidade da voz: ${velocidadeTexto}`, 'sucesso');
            falar('Teste de velocidade da voz');
        }

        function falar(texto) {
            if (!estado.somAtivado || !('speechSynthesis' in window)) return;
            window.speechSynthesis.cancel();
            const textoLimpo = texto.replace(/[*_#`]/g, '').replace(/<[^>]*>/g, '').replace(/\n+/g, '. ');
            const utterance = new SpeechSynthesisUtterance(textoLimpo);
            utterance.lang = 'pt-BR';
            utterance.rate = estado.velocidadeVoz;
            utterance.pitch = 1.0;
            utterance.volume = 1.0;
            window.speechSynthesis.speak(utterance);
        }

        function ativarMicrofone() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                mostrarToast('Seu navegador n√£o suporta reconhecimento de voz', 'erro');
                return;
            }
            const recognition = new SpeechRecognition();
            recognition.lang = 'pt-BR';
            recognition.continuous = false;
            recognition.interimResults = false;
            const btnMic = document.getElementById('btn-mic');
            recognition.onstart = () => {
                btnMic.classList.add('ouvindo');
                mostrarToast('üé§ Estou ouvindo...', 'aviso');
            };
            recognition.onend = () => {
                btnMic.classList.remove('ouvindo');
            };
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                document.getElementById('entradaUsuario').value = transcript;
                document.getElementById('entradaUsuario').focus();
                autoResizeTextarea(document.getElementById('entradaUsuario'));
                mostrarToast('‚úì Texto capturado!', 'sucesso');
            };
            recognition.onerror = (event) => {
                btnMic.classList.remove('ouvindo');
                let mensagem = 'Erro ao capturar voz';
                if (event.error === 'no-speech') mensagem = 'Nenhuma fala detectada';
                else if (event.error === 'not-allowed') mensagem = 'Permiss√£o de microfone negada';
                mostrarToast(mensagem, 'erro');
            };
            try {
                recognition.start();
            } catch (e) {
                mostrarToast('Erro ao iniciar microfone', 'erro');
            }
        }

        // ===== MODOS DE CONTEXTO =====
        function ativarModoContexto(modo) {
            document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('ativo'));
            event.target.closest('.tool-btn').classList.add('ativo');
            estado.modoContexto = modo;
            
            const modos = {
                criativo: '‚ú® Modo Criativo ativado - Respostas mais imaginativas',
                preciso: 'üéØ Modo Preciso ativado - Respostas mais factuais',
                codigo: 'üíª Modo C√≥digo ativado - Especialista em programa√ß√£o',
                ensino: 'üéì Modo Ensino ativado - Explica√ß√µes did√°ticas',
                analise: 'üî¨ Modo An√°lise ativado - An√°lises profundas'
            };
            
            mostrarToast(modos[modo], 'sucesso');
        }

        // ===== ANEXAR ARQUIVOS =====
        function anexarArquivo() {
            document.getElementById('fileInput').click();
        }

        async function processarArquivos(event) {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;
            
            for (const file of files) {
                if (file.size > 10 * 1024 * 1024) {
                    mostrarToast(`Arquivo ${file.name} muito grande (m√°x 10MB)`, 'erro');
                    continue;
                }
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const conteudo = e.target.result;
                    const tipoArquivo = file.type.startsWith('image/') ? 'imagem' : 'documento';
                    
                    estado.arquivosAnexados.push({
                        nome: file.name,
                        tipo: tipoArquivo,
                        tamanho: file.size,
                        conteudo: conteudo
                    });
                    
                    mostrarArquivoAnexado(file.name, file.size, tipoArquivo);
                    mostrarToast(`‚úì ${file.name} anexado!`, 'sucesso');
                };
                
                if (file.type.startsWith('image/')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsText(file);
                }
            }
            
            event.target.value = '';
        }

        function mostrarArquivoAnexado(nome, tamanho, tipo) {
            const chat = document.getElementById('chat-container');
            const wrapper = document.createElement('div');
            wrapper.className = 'mensagem-wrapper usuario-wrapper';
            
            const icones = {
                'imagem': 'üñºÔ∏è',
                'documento': 'üìÑ'
            };
            
            wrapper.innerHTML = `
                <div class="mensagem usuario">
                    <div class="file-attachment">
                        <div class="file-icon">${icones[tipo]}</div>
                        <div class="file-info">
                            <div class="file-name">${nome}</div>
                            <div class="file-size">${formatarTamanho(tamanho)}</div>
                        </div>
                    </div>
                </div>
            `;
            
            chat.appendChild(wrapper);
            chat.scrollTop = chat.scrollHeight;
        }

        function formatarTamanho(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
        }

        // ===== ENVIAR MENSAGEM =====
        function usarChip(texto) {
            document.getElementById('entradaUsuario').value = texto + ' ';
            document.getElementById('entradaUsuario').focus();
            autoResizeTextarea(document.getElementById('entradaUsuario'));
        }

        async function enviarMensagem() {
            const input = document.getElementById('entradaUsuario');
            const texto = input.value.trim();
            
            if (!texto && estado.arquivosAnexados.length === 0) return;
            if (estado.aguardandoResposta) return;
            
            let mensagemCompleta = texto;
            
            // ===== ENVIAR MENSAGEM =====
async function enviarMensagem() {
    const input = document.getElementById('entradaUsuario');
    const texto = input.value.trim();
    
    if (!texto && estado.arquivosAnexados.length === 0) {
        mostrarToast('Digite uma mensagem ou anexe um arquivo', 'aviso');
        return;
    }
    
    if (estado.aguardandoResposta) {
        mostrarToast('Aguarde a resposta atual', 'aviso');
        return;
    }
    
    let mensagemCompleta = texto;
    
    // Adicionar informa√ß√µes dos arquivos anexados
    if (estado.arquivosAnexados.length > 0) {
        mensagemCompleta += "\n\nüìé **Arquivos anexados:**";
        estado.arquivosAnexados.forEach(arquivo => {
            mensagemCompleta += `\n- ${arquivo.nome} (${arquivo.tipo})`;
            
            // Para arquivos de texto, incluir o conte√∫do
            if (arquivo.tipo === 'documento' && arquivo.conteudo) {
                mensagemCompleta += `\n  Conte√∫do: ${arquivo.conteudo.substring(0, 500)}...`;
            }
        });
    }

    // Adicionar mensagem do usu√°rio ao chat
    adicionarMensagem(mensagemCompleta, 'usuario');
    estado.conversaAtual.push({ role: 'user', content: mensagemCompleta });

    // Limpar input e arquivos
    input.value = '';
    input.style.height = 'auto';
    estado.arquivosAnexados = [];
    document.getElementById('contador-chars').textContent = '0/4000';
    estado.aguardandoResposta = true;

    // Mostrar indicador de digita√ß√£o
    mostrarDigitando();

    try {
        const resposta = await gerarRespostaIA(mensagemCompleta);
        
        // Remover indicador de digita√ß√£o
        removerDigitando();
        
        // Adicionar resposta ao chat
        adicionarMensagem(resposta, 'cici', true);
        estado.conversaAtual.push({ role: 'assistant', content: resposta });
        
        // Falar resposta se √°udio estiver ativado
        falar(resposta);
        
    } catch (error) {
        removerDigitando();
        console.error('Erro na API:', error);
        
        let mensagemErro = "Desculpe, ocorreu um erro ao processar sua solicita√ß√£o. ";
        
        if (error.message.includes('API key')) {
            mensagemErro = "‚ö†Ô∏è **Configura√ß√£o de API necess√°ria**\n\nPara usar a Cici AI, configure:\n\n1. Sua chave da API Mistral em `CONFIG.MISTRAL_API_KEY`\n2. URL e chave do Supabase para armazenamento\n\nSem essas configura√ß√µes, a aplica√ß√£o n√£o pode se conectar aos servi√ßos de IA.";
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            mensagemErro = "üåê **Erro de conex√£o**\n\nVerifique sua conex√£o com a internet e tente novamente.";
        } else if (error.message.includes('rate limit') || error.status === 429) {
            mensagemErro = "‚è≥ **Limite de requisi√ß√µes**\n\nMuitas requisi√ß√µes em um curto per√≠odo. Tente novamente em alguns instantes.";
        } else if (error.status === 401) {
            mensagemErro = "üîë **Erro de autentica√ß√£o**\n\nChave da API inv√°lida ou expirada. Verifique suas credenciais.";
        } else if (error.status >= 500) {
            mensagemErro = "‚ö° **Erro do servidor**\n\nO servi√ßo de IA est√° temporariamente indispon√≠vel. Tente novamente em alguns minutos.";
        }
        
        adicionarMensagem(mensagemErro, 'cici', true);
        mostrarToast('Erro na comunica√ß√£o com a IA', 'erro');
    }

    estado.aguardandoResposta = false;
}

async function gerarRespostaIA(mensagem) {
    // Verificar se a API key est√° configurada
    if (CONFIG.MISTRAL_API_KEY === 'SUA_CHAVE_API_MISTRAL_AQUI') {
        throw new Error('API key n√£o configurada');
    }

    // Preparar hist√≥rico da conversa
    const historico = estado.conversaAtual.slice(-CONFIG.MAX_HISTORICO);
    
    // Configurar par√¢metros baseados no modo de contexto
    let temperatura = 0.7; // padr√£o
    let maxTokens = 2000;
    
    switch(estado.modoContexto) {
        case 'preciso':
            temperatura = 0.3;
            break;
        case 'criativo':
            temperatura = 0.9;
            break;
        case 'codigo':
            temperatura = 0.5;
            maxTokens = 3000;
            break;
        case 'ensino':
            temperatura = 0.6;
            break;
        case 'analise':
            temperatura = 0.4;
            maxTokens = 2500;
            break;
    }

    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.MISTRAL_API_KEY}`
        },
        body: JSON.stringify({
            model: 'mistral-small', // ou mistral-medium para mais capacidade
            messages: [
                {
                    role: 'system',
                    content: `Voc√™ √© a Cici AI, uma assistente multifuncional avan√ßada. 
                    Responda de forma clara, √∫til e detalhada. 
                    Formate respostas usando Markdown quando apropriado.
                    Seja direta e evite textos muito longos sem formata√ß√£o.`
                },
                ...historico,
                { role: 'user', content: mensagem }
            ],
            temperature: temperatura,
            max_tokens: maxTokens,
            top_p: 0.9,
            stream: false
        })
    });

    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`HTTP ${response.status}: ${errorData.message || 'Erro na API'}`);
    }

    const data = await response.json();
    
    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('Resposta da API inv√°lida');
    }

    return data.choices[0].message.content;
}

// ===== FUN√á√ïES DO CHAT =====
function adicionarMensagem(texto, tipo, renderMarkdown = true) {
    const chat = document.getElementById('chat-container');
    const wrapper = document.createElement('div');
    wrapper.className = `mensagem-wrapper ${tipo}-wrapper`;

    const hora = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });

    let conteudo = texto;
    if (renderMarkdown && tipo === 'cici') {
        try {
            conteudo = marked.parse(texto);
        } catch (e) {
            console.error('Erro ao processar markdown:', e);
            conteudo = texto.replace(/\n/g, '<br>');
        }
    } else {
        conteudo = texto.replace(/\n/g, '<br>');
    }

    wrapper.innerHTML = `
        <div class="mensagem ${tipo}">
            ${conteudo}
            <div class="mensagem-hora">${hora}</div>
            ${tipo === 'cici' ? `
            <div class="mensagem-acoes">
                <button class="btn-acao" onclick="copiarTexto(this, '${escapeTexto(texto)}')">
                    üìã Copiar
                </button>
                <button class="btn-acao" onclick="falar('${escapeTexto(texto)}')" ${!estado.somAtivado ? 'disabled' : ''}>
                    üîä Ouvir
                </button>
            </div>
            ` : ''}
        </div>
    `;

    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;

    // Aplicar syntax highlighting para c√≥digo
    wrapper.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
        
        // Adicionar bot√£o de copiar para blocos de c√≥digo
        const pre = block.closest('pre');
        if (pre && !pre.querySelector('.code-header')) {
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
                <span class="code-language">${block.className.replace('language-', '') || 'code'}</span>
                <button class="code-copy-btn" onclick="copiarCodigo(this)">Copiar</button>
            `;
            pre.insertBefore(header, pre.firstChild);
        }
    });
}

function escapeTexto(texto) {
    return texto.replace(/'/g, "\\'").replace(/\n/g, '\\n');
}

// ===== MENSAGEM DE BOAS-VINDAS REAL =====
function mostrarMensagemBoasVindas() {
    const mensagem = `# üöÄ Ol√°! Eu sou a **Cici AI**

Sou uma assistente multifuncional avan√ßada conectada √† API Mistral. 

**üéØ Funcionalidades Dispon√≠veis:**
‚Ä¢ üí¨ Conversa√ß√£o natural e contextual
‚Ä¢ üíª Gera√ß√£o e an√°lise de c√≥digo
‚Ä¢ üìÑ Processamento de documentos anexados
‚Ä¢ üé® Conte√∫do criativo e brainstorming
‚Ä¢ üî¨ An√°lise profunda de problemas
‚Ä¢ üåç Tradu√ß√£o e suporte multil√≠ngue

**‚ö° Modos de Opera√ß√£o:**
‚Ä¢ \`Criativo\` - Respostas imaginativas
‚Ä¢ \`Preciso\` - Respostas factuais e diretas  
‚Ä¢ \`C√≥digo\` - Especialista em programa√ß√£o
‚Ä¢ \`Ensino\` - Explica√ß√µes did√°ticas
‚Ä¢ \`An√°lise\` - An√°lises detalhadas

**üìé Posso processar:** Textos, PDFs, imagens e outros documentos.

Como posso ajud√°-lo hoje?`;

    adicionarMensagem(mensagem, 'cici', false);
}

// ===== CONFIGURA√á√ÉO DE API =====
function verificarConfiguracaoAPI() {
    if (CONFIG.MISTRAL_API_KEY === 'SUA_CHAVE_API_MISTRAL_AQUI') {
        console.warn('‚ö†Ô∏è API Mistral n√£o configurada');
        return false;
    }
    return true;
}

// Modificar a fun√ß√£o de inicializa√ß√£o para verificar a API
window.onload = () => {
    carregarConfiguracoes();
    carregarHistorico();
    configurarEventos();
    aplicarConfiguracoes();
    verificarSuporteFuncionalidades();
    
    if (!verificarConfiguracaoAPI()) {
        console.log('Configure a API Mistral para uso completo');
    }
};

// Adicionar verifica√ß√£o ao enviar primeira mensagem
function irParaChat() {
    document.getElementById('tela-aviso').classList.add('oculto');
    document.getElementById('tela-app').classList.remove('oculto');
    
    const chat = document.getElementById('chat-container');
    if (chat.children.length === 0) {
        setTimeout(() => {
            if (!verificarConfiguracaoAPI()) {
                const avisoConfig = `# ‚ö†Ô∏è **Configura√ß√£o Necess√°ria**

Para usar toda a funcionalidade da Cici AI, configure:

1. **API Mistral**: Obtenha uma chave em https://mistral.ai
2. **Supabase**: Para armazenamento de conversas (opcional)

**Configura√ß√£o atual:**
‚Ä¢ Mistral API: ${CONFIG.MISTRAL_API_KEY === 'SUA_CHAVE_API_MISTRAL_AQUI' ? '‚ùå N√£o configurada' : '‚úÖ Configurada'}
‚Ä¢ Supabase: ${CONFIG.SUPABASE_URL === 'SUA_URL_SUPABASE_AQUI' ? '‚ùå N√£o configurado' : '‚úÖ Configurado'}

Enquanto isso, voc√™ pode testar a interface, mas as respostas da IA n√£o estar√£o dispon√≠veis.`;
                adicionarMensagem(avisoConfig, 'cici', true);
            } else {
                mostrarMensagemBoasVindas();
            }
        }, 300);
    }
}
// ===== CONFIGURA√á√ïES =====
const CONFIG = {
    MISTRAL_API_KEY: 'SUA_CHAVE_API_MISTRAL_AQUI',
    SUPABASE_URL: 'SUA_URL_SUPABASE_AQUI',
    SUPABASE_KEY: 'SUA_CHAVE_ANON_SUPABASE_AQUI',
    MAX_HISTORICO: 15,
    MAX_CHARS: 4000,
    VELOCIDADE_VOZ_PADRAO: 1.0,
    MODELOS_DISPONIVEIS: ['mistral-tiny', 'mistral-small', 'mistral-medium']
};

let estado = {
    somAtivado: false,
    velocidadeVoz: CONFIG.VELOCIDADE_VOZ_PADRAO,
    tamanhoFonte: 16,
    temaEscuro: false,
    altoContraste: false,
    leituraFacilitada: false,
    conversaAtual: [],
    aguardandoResposta: false,
    modoContexto: 'normal',
    arquivosAnexados: []
};

let supabase = null;
if (CONFIG.SUPABASE_URL !== 'SUA_URL_SUPABASE_AQUI' && CONFIG.SUPABASE_KEY !== 'SUA_CHAVE_ANON_SUPABASE_AQUI') {
    supabase = window.supabase.createClient(CONFIG.SUPABASE_URL, CONFIG.SUPABASE_KEY);
}

marked.setOptions({ 
    breaks: true,
    highlight: function(code, lang) {
        if (lang && hljs.getLanguage(lang)) {
            return hljs.highlight(code, { language: lang }).value;
        }
        return hljs.highlightAuto(code).value;
    }
});

// ===== INICIALIZA√á√ÉO =====
window.onload = () => {
    carregarConfiguracoes();
    carregarHistorico();
    configurarEventos();
    aplicarConfiguracoes();
    verificarSuporteFuncionalidades();
};

function carregarConfiguracoes() {
    const configs = JSON.parse(localStorage.getItem('ciciConfigs') || '{}');
    estado = { ...estado, ...configs };
    if (localStorage.getItem('altoContraste') === 'true') {
        estado.altoContraste = true;
    }
}

function salvarConfiguracoes() {
    localStorage.setItem('ciciConfigs', JSON.stringify(estado));
}

function aplicarConfiguracoes() {
    if (estado.temaEscuro) {
        document.body.classList.add('tema-escuro');
        document.getElementById('toggle-tema').classList.add('ativo');
        document.getElementById('icone-tema').textContent = '‚òÄÔ∏è';
        document.getElementById('texto-tema').textContent = 'Modo Claro';
    }
    if (estado.altoContraste) {
        document.body.classList.add('alto-contraste');
        document.getElementById('toggle-contraste').classList.add('ativo');
    }
    if (estado.leituraFacilitada) {
        document.body.classList.add('leitura-facilitada');
        document.getElementById('toggle-leitura').classList.add('ativo');
    }
    if (estado.somAtivado) {
        document.getElementById('toggle-som').classList.add('ativo');
        document.getElementById('icone-som').textContent = 'üîä';
        document.getElementById('texto-som').textContent = 'Desativar Voz';
    }
    document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
}

function configurarEventos() {
    const input = document.getElementById('entradaUsuario');
    
    input.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            enviarMensagem();
        }
    });
    
    input.addEventListener('input', () => {
        autoResizeTextarea(input);
        const contador = document.getElementById('contador-chars');
        contador.textContent = `${input.value.length}/${CONFIG.MAX_CHARS}`;
        if (input.value.length > CONFIG.MAX_CHARS * 0.9) {
            contador.style.color = 'var(--danger)';
        } else {
            contador.style.color = 'var(--text-secondary)';
        }
    });

    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            input.focus();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
            e.preventDefault();
            limparChat();
        }
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
            e.preventDefault();
            exportarConversa();
        }
        if (e.key === 'Escape') {
            fecharMenu();
        }
    });

    document.getElementById('fileInput').addEventListener('change', processarArquivos);
}

function autoResizeTextarea(textarea) {
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
}

function verificarSuporteFuncionalidades() {
    const temReconhecimentoVoz = 'SpeechRecognition' in window || 'webkitSpeechRecognition' in window;
    if (!temReconhecimentoVoz) {
        document.getElementById('btn-mic').style.display = 'none';
    }
}

// ===== NAVEGA√á√ÉO =====
function irParaAviso() {
    document.getElementById('tela-boas-vindas').classList.add('oculto');
    document.getElementById('tela-aviso').classList.remove('oculto');
}

function irParaChat() {
    document.getElementById('tela-aviso').classList.add('oculto');
    document.getElementById('tela-app').classList.remove('oculto');
    
    const chat = document.getElementById('chat-container');
    if (chat.children.length === 0) {
        setTimeout(() => mostrarMensagemBoasVindas(), 300);
    }
}

function mostrarMensagemBoasVindas() {
    const mensagem = `# üöÄ Ol√°! Eu sou a **Cici AI**

Sou uma assistente multifuncional avan√ßada. 

**üéØ Funcionalidades Dispon√≠veis:**
‚Ä¢ üí¨ Conversa√ß√£o natural e contextual
‚Ä¢ üíª Gera√ß√£o e an√°lise de c√≥digo  
‚Ä¢ üìÑ Processamento de documentos
‚Ä¢ üé® Conte√∫do criativo e brainstorming
‚Ä¢ üî¨ An√°lise profunda de problemas
‚Ä¢ üåç Tradu√ß√£o e suporte multil√≠ngue

**‚ö° Modos de Opera√ß√£o:**
‚Ä¢ **Criativo** - Respostas imaginativas
‚Ä¢ **Preciso** - Respostas factuais
‚Ä¢ **C√≥digo** - Especialista em programa√ß√£o
‚Ä¢ **Ensino** - Explica√ß√µes did√°ticas
‚Ä¢ **An√°lise** - An√°lises detalhadas

Como posso ajud√°-lo hoje?`;

    adicionarMensagem(mensagem, 'cici', true);
}

function abrirMenu() {
    document.getElementById('side-menu').classList.add('aberto');
    document.getElementById('overlay-menu').classList.add('aberto');
    document.body.style.overflow = 'hidden';
}

function fecharMenu() {
    document.getElementById('side-menu').classList.remove('aberto');
    document.getElementById('overlay-menu').classList.remove('aberto');
    document.body.style.overflow = '';
}

function novaConversa() {
    if (estado.conversaAtual.length === 0) {
        mostrarToast('J√° est√° em uma conversa nova', 'info');
        return;
    }
    if (confirm('Deseja iniciar uma nova conversa? A conversa atual ser√° salva.')) {
        const timestamp = Date.now();
        localStorage.setItem(`ciciChat_${timestamp}`, JSON.stringify(estado.conversaAtual));
        limparChat();
        setTimeout(() => mostrarMensagemBoasVindas(), 300);
        mostrarToast('Nova conversa iniciada!', 'sucesso');
    }
}

// ===== APAR√äNCIA =====
function alternarTemaEscuro() {
    estado.temaEscuro = !estado.temaEscuro;
    document.body.classList.toggle('tema-escuro');
    const toggle = document.getElementById('toggle-tema');
    const icone = document.getElementById('icone-tema');
    const texto = document.getElementById('texto-tema');
    if (estado.temaEscuro) {
        toggle.classList.add('ativo');
        icone.textContent = '‚òÄÔ∏è';
        texto.textContent = 'Modo Claro';
    } else {
        toggle.classList.remove('ativo');
        icone.textContent = 'üåô';
        texto.textContent = 'Modo Escuro';
    }
    salvarConfiguracoes();
    mostrarToast('Tema alterado!', 'sucesso');
}

function alternarContraste() {
    estado.altoContraste = !estado.altoContraste;
    document.body.classList.toggle('alto-contraste');
    document.getElementById('toggle-contraste').classList.toggle('ativo');
    localStorage.setItem('altoContraste', estado.altoContraste);
    salvarConfiguracoes();
    mostrarToast('Alto contraste ' + (estado.altoContraste ? 'ativado' : 'desativado'), 'sucesso');
}

function alternarLeituraFacilitada() {
    estado.leituraFacilitada = !estado.leituraFacilitada;
    document.body.classList.toggle('leitura-facilitada');
    document.getElementById('toggle-leitura').classList.toggle('ativo');
    salvarConfiguracoes();
    mostrarToast('Leitura facilitada ' + (estado.leituraFacilitada ? 'ativada' : 'desativada'), 'sucesso');
}

function ajustarFonte(incremento) {
    estado.tamanhoFonte = Math.max(12, Math.min(28, estado.tamanhoFonte + incremento));
    document.documentElement.style.fontSize = estado.tamanhoFonte + 'px';
    salvarConfiguracoes();
    mostrarToast(`Tamanho: ${estado.tamanhoFonte}px`, 'sucesso');
}

function resetarFonte() {
    estado.tamanhoFonte = 16;
    document.documentElement.style.fontSize = '16px';
    salvarConfiguracoes();
    mostrarToast('Tamanho padr√£o restaurado', 'sucesso');
}

// ===== √ÅUDIO =====
function alternarSom() {
    estado.somAtivado = !estado.somAtivado;
    const toggle = document.getElementById('toggle-som');
    const icone = document.getElementById('icone-som');
    const texto = document.getElementById('texto-som');
    if (estado.somAtivado) {
        toggle.classList.add('ativo');
        icone.textContent = 'üîä';
        texto.textContent = 'Desativar Voz';
        falar('Voz ativada com sucesso!');
    } else {
        toggle.classList.remove('ativo');
        icone.textContent = 'üîá';
        texto.textContent = 'Ativar Voz';
        window.speechSynthesis.cancel();
    }
    salvarConfiguracoes();
}

function ajustarVelocidadeVoz(incremento) {
    estado.velocidadeVoz = Math.max(0.5, Math.min(2.0, estado.velocidadeVoz + incremento));
    salvarConfiguracoes();
    const velocidadeTexto = estado.velocidadeVoz === 1.0 ? 'normal' : 
                           estado.velocidadeVoz < 1.0 ? 'lenta' : 'r√°pida';
    mostrarToast(`Velocidade da voz: ${velocidadeTexto}`, 'sucesso');
    if (estado.somAtivado) {
        falar('Teste de velocidade da voz');
    }
}

function falar(texto) {
    if (!estado.somAtivado || !('speechSynthesis' in window)) return;
    window.speechSynthesis.cancel();
    const textoLimpo = texto.replace(/[*_#`]/g, '').replace(/<[^>]*>/g, '').replace(/\n+/g, '. ');
    const utterance = new SpeechSynthesisUtterance(textoLimpo);
    utterance.lang = 'pt-BR';
    utterance.rate = estado.velocidadeVoz;
    utterance.pitch = 1.0;
    utterance.volume = 1.0;
    window.speechSynthesis.speak(utterance);
}

function ativarMicrofone() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) {
        mostrarToast('Seu navegador n√£o suporta reconhecimento de voz', 'erro');
        return;
    }
    const recognition = new SpeechRecognition();
    recognition.lang = 'pt-BR';
    recognition.continuous = false;
    recognition.interimResults = false;
    const btnMic = document.getElementById('btn-mic');
    recognition.onstart = () => {
        btnMic.classList.add('ouvindo');
        mostrarToast('üé§ Estou ouvindo...', 'aviso');
    };
    recognition.onend = () => {
        btnMic.classList.remove('ouvindo');
    };
    recognition.onresult = (event) => {
        const transcript = event.results[0][0].transcript;
        document.getElementById('entradaUsuario').value = transcript;
        document.getElementById('entradaUsuario').focus();
        autoResizeTextarea(document.getElementById('entradaUsuario'));
        mostrarToast('‚úì Texto capturado!', 'sucesso');
    };
    recognition.onerror = (event) => {
        btnMic.classList.remove('ouvindo');
        let mensagem = 'Erro ao capturar voz';
        if (event.error === 'no-speech') mensagem = 'Nenhuma fala detectada';
        else if (event.error === 'not-allowed') mensagem = 'Permiss√£o de microfone negada';
        mostrarToast(mensagem, 'erro');
    };
    try {
        recognition.start();
    } catch (e) {
        mostrarToast('Erro ao iniciar microfone', 'erro');
    }
}

// ===== MODOS DE CONTEXTO =====
function ativarModoContexto(modo) {
    document.querySelectorAll('.tool-btn').forEach(btn => btn.classList.remove('ativo'));
    event.target.closest('.tool-btn').classList.add('ativo');
    estado.modoContexto = modo;
    
    const modos = {
        criativo: '‚ú® Modo Criativo ativado - Respostas mais imaginativas',
        preciso: 'üéØ Modo Preciso ativado - Respostas mais factuais',
        codigo: 'üíª Modo C√≥digo ativado - Especialista em programa√ß√£o',
        ensino: 'üéì Modo Ensino ativado - Explica√ß√µes did√°ticas',
        analise: 'üî¨ Modo An√°lise ativado - An√°lises profundas'
    };
    
    mostrarToast(modos[modo], 'sucesso');
}

// ===== ANEXAR ARQUIVOS =====
function anexarArquivo() {
    document.getElementById('fileInput').click();
}

async function processarArquivos(event) {
    const files = Array.from(event.target.files);
    if (files.length === 0) return;
    
    for (const file of files) {
        if (file.size > 10 * 1024 * 1024) {
            mostrarToast(`Arquivo ${file.name} muito grande (m√°x 10MB)`, 'erro');
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = async (e) => {
            const conteudo = e.target.result;
            const tipoArquivo = file.type.startsWith('image/') ? 'imagem' : 'documento';
            
            estado.arquivosAnexados.push({
                nome: file.name,
                tipo: tipoArquivo,
                tamanho: file.size,
                conteudo: conteudo
            });
            
            mostrarArquivoAnexado(file.name, file.size, tipoArquivo);
            mostrarToast(`‚úì ${file.name} anexado!`, 'sucesso');
        };
        
        if (file.type.startsWith('image/')) {
            reader.readAsDataURL(file);
        } else {
            reader.readAsText(file);
        }
    }
    
    event.target.value = '';
}

function mostrarArquivoAnexado(nome, tamanho, tipo) {
    const chat = document.getElementById('chat-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'mensagem-wrapper usuario-wrapper';
    
    const icones = {
        'imagem': 'üñºÔ∏è',
        'documento': 'üìÑ'
    };
    
    wrapper.innerHTML = `
        <div class="mensagem usuario">
            <div class="file-attachment">
                <div class="file-icon">${icones[tipo]}</div>
                <div class="file-info">
                    <div class="file-name">${nome}</div>
                    <div class="file-size">${formatarTamanho(tamanho)}</div>
                </div>
            </div>
        </div>
    `;
    
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
}

function formatarTamanho(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// ===== ENVIAR MENSAGEM =====
function usarChip(texto) {
    document.getElementById('entradaUsuario').value = texto + ' ';
    document.getElementById('entradaUsuario').focus();
    autoResizeTextarea(document.getElementById('entradaUsuario'));
}

async function enviarMensagem() {
    const input = document.getElementById('entradaUsuario');
    const texto = input.value.trim();
    
    if (!texto && estado.arquivosAnexados.length === 0) {
        mostrarToast('Digite uma mensagem ou anexe um arquivo', 'aviso');
        return;
    }
    
    if (estado.aguardandoResposta) {
        mostrarToast('Aguarde a resposta atual', 'aviso');
        return;
    }
    
    let mensagemCompleta = texto;
    
    // Adicionar informa√ß√µes dos arquivos anexados
    if (estado.arquivosAnexados.length > 0) {
        mensagemCompleta += "\n\nüìé **Arquivos anexados:**";
        estado.arquivosAnexados.forEach(arquivo => {
            mensagemCompleta += `\n- ${arquivo.nome} (${arquivo.tipo})`;
            
            // Para arquivos de texto, incluir o conte√∫do
            if (arquivo.tipo === 'documento' && arquivo.conteudo) {
                mensagemCompleta += `\n  Conte√∫do: ${arquivo.conteudo.substring(0, 500)}...`;
            }
        });
    }

    // Adicionar mensagem do usu√°rio ao chat
    adicionarMensagem(mensagemCompleta, 'usuario');
    estado.conversaAtual.push({ role: 'user', content: mensagemCompleta });

    // Limpar input e arquivos
    input.value = '';
    input.style.height = 'auto';
    estado.arquivosAnexados = [];
    document.getElementById('contador-chars').textContent = '0/4000';
    estado.aguardandoResposta = true;

    // Mostrar indicador de digita√ß√£o
    mostrarDigitando();

    try {
        const resposta = await gerarRespostaIA(mensagemCompleta);
        
        // Remover indicador de digita√ß√£o
        removerDigitando();
        
        // Adicionar resposta ao chat
        adicionarMensagem(resposta, 'cici', true);
        estado.conversaAtual.push({ role: 'assistant', content: resposta });
        
        // Falar resposta se √°udio estiver ativado
        falar(resposta);
        
    } catch (error) {
        removerDigitando();
        console.error('Erro na API:', error);
        
        let mensagemErro = "Desculpe, ocorreu um erro ao processar sua solicita√ß√£o. ";
        
        if (error.message.includes('API key')) {
            mensagemErro = "‚ö†Ô∏è **Configura√ß√£o de API necess√°ria**\n\nPara usar a Cici AI, configure:\n\n1. Sua chave da API Mistral em `CONFIG.MISTRAL_API_KEY`\n2. URL e chave do Supabase para armazenamento\n\nSem essas configura√ß√µes, a aplica√ß√£o n√£o pode se conectar aos servi√ßos de IA.";
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            mensagemErro = "üåê **Erro de conex√£o**\n\nVerifique sua conex√£o com a internet e tente novamente.";
        } else if (error.message.includes('rate limit') || error.status === 429) {
            mensagemErro = "‚è≥ **Limite de requisi√ß√µes**\n\nMuitas requisi√ß√µes em um curto per√≠odo. Tente novamente em alguns instantes.";
        } else if (error.status === 401) {
            mensagemErro = "üîë **Erro de autentica√ß√£o**\n\nChave da API inv√°lida ou expirada. Verifique suas credenciais.";
        } else if (error.status >= 500) {
            mensagemErro = "‚ö° **Erro do servidor**\n\nO servi√ßo de IA est√° temporariamente indispon√≠vel. Tente novamente em alguns minutos.";
        }
        
        adicionarMensagem(mensagemErro, 'cici', true);
        mostrarToast('Erro na comunica√ß√£o com a IA', 'erro');
    }

    estado.aguardandoResposta = false;
}

async function gerarRespostaIA(mensagem) {
    // Verificar se a API key est√° configurada
    if (CONFIG.MISTRAL_API_KEY === 'SUA_CHAVE_API_MISTRAL_AQUI') {
        throw new Error('API key n√£o configurada');
    }

    // Preparar hist√≥rico da conversa
    const historico = estado.conversaAtual.slice(-CONFIG.MAX_HISTORICO);
    
    // Configurar par√¢metros baseados no modo de contexto
    let temperatura = 0.7; // padr√£o
    let maxTokens = 2000;
    
    switch(estado.modoContexto) {
        case 'preciso':
            temperatura = 0.3;
            break;
        case 'criativo':
            temperatura = 0.9;
            break;
        case 'codigo':
            temperatura = 0.5;
            maxTokens = 3000;
            break;
        case 'ensino':
            temperatura = 0.6;
            break;
        case 'analise':
            temperatura = 0.4;
            maxTokens = 2500;
            break;
    }

    const response = await fetch('https://api.mistral.ai/v1/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${CONFIG.MISTRAL_API_KEY}`
        },
        body: JSON.stringify({
            model: 'mistral-small',
            messages: [
                {
                    role: 'system',
                    content: `Voc√™ √© a Cici AI, uma assistente multifuncional avan√ßada. 
                    Responda de forma clara, √∫til e detalhada. 
                    Formate respostas usando Markdown quando apropriado.
                    Seja direta e evite textos muito longos sem formata√ß√£o.`
                },
                ...historico,
                { role: 'user', content: mensagem }
            ],
            temperature: temperatura,
            max_tokens: maxTokens,
            top_p: 0.9,
            stream: false
        })
    });

    if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(`HTTP ${response.status}: ${errorData.message || 'Erro na API'}`);
    }

    const data = await response.json();
    
    if (!data.choices || !data.choices[0] || !data.choices[0].message) {
        throw new Error('Resposta da API inv√°lida');
    }

    return data.choices[0].message.content;
}

// ===== FUN√á√ïES DO CHAT =====
function adicionarMensagem(texto, tipo, renderMarkdown = true) {
    const chat = document.getElementById('chat-container');
    const wrapper = document.createElement('div');
    wrapper.className = `mensagem-wrapper ${tipo}-wrapper`;

    const hora = new Date().toLocaleTimeString('pt-BR', { 
        hour: '2-digit', 
        minute: '2-digit' 
    });

    let conteudo = texto;
    if (renderMarkdown && tipo === 'cici') {
        try {
            conteudo = marked.parse(texto);
        } catch (e) {
            console.error('Erro ao processar markdown:', e);
            conteudo = texto.replace(/\n/g, '<br>');
        }
    } else {
        conteudo = texto.replace(/\n/g, '<br>');
    }

    wrapper.innerHTML = `
        <div class="mensagem ${tipo}">
            ${conteudo}
            <div class="mensagem-hora">${hora}</div>
            ${tipo === 'cici' ? `
            <div class="mensagem-acoes">
                <button class="btn-acao" onclick="copiarTexto(this, '${escapeTexto(texto)}')">
                    üìã Copiar
                </button>
                <button class="btn-acao" onclick="falar('${escapeTexto(texto)}')" ${!estado.somAtivado ? 'disabled' : ''}>
                    üîä Ouvir
                </button>
            </div>
            ` : ''}
        </div>
    `;

    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;

    // Aplicar syntax highlighting para c√≥digo
    wrapper.querySelectorAll('pre code').forEach((block) => {
        hljs.highlightElement(block);
        
        // Adicionar bot√£o de copiar para blocos de c√≥digo
        const pre = block.closest('pre');
        if (pre && !pre.querySelector('.code-header')) {
            const header = document.createElement('div');
            header.className = 'code-header';
            header.innerHTML = `
                <span class="code-language">${block.className.replace('language-', '') || 'code'}</span>
                <button class="code-copy-btn" onclick="copiarCodigo(this)">Copiar</button>
            `;
            pre.insertBefore(header, pre.firstChild);
        }
    });
}

function escapeTexto(texto) {
    return texto.replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/"/g, '\\"');
}

function mostrarDigitando() {
    const chat = document.getElementById('chat-container');
    const wrapper = document.createElement('div');
    wrapper.className = 'mensagem-wrapper cici-wrapper';
    wrapper.id = 'digitando-indicator';
    wrapper.innerHTML = `
        <div class="mensagem cici">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    chat.appendChild(wrapper);
    chat.scrollTop = chat.scrollHeight;
}

function removerDigitando() {
    const indicator = document.getElementById('digitando-indicator');
    if (indicator) {
        indicator.remove();
    }
}

// ===== A√á√ïES DE MENSAGEM =====
function copiarTexto(botao, texto) {
    navigator.clipboard.writeText(texto).then(() => {
        const original = botao.innerHTML;
        botao.innerHTML = '‚úÖ Copiado!';
        botao.style.background = 'var(--success)';
        setTimeout(() => {
            botao.innerHTML = original;
            botao.style.background = '';
        }, 2000);
    }).catch(err => {
        mostrarToast('Erro ao copiar texto', 'erro');
    });
}

function copiarCodigo(botao) {
    const codeBlock = botao.closest('.code-header').nextElementSibling;
    const texto = codeBlock.textContent;
    copiarTexto(botao, texto);
}

// ===== GERENCIAMENTO DE CONVERSAS =====
function carregarHistorico() {
    // Carregar conversas salvas do localStorage
    const chaves = Object.keys(localStorage).filter(key => key.startsWith('ciciChat_'));
    if (chaves.length > 0) {
        console.log(`${chaves.length} conversas salvas encontradas`);
    }
}

function limparChat() {
    if (confirm('Tem certeza que deseja limpar toda a conversa? Esta a√ß√£o n√£o pode ser desfeita.')) {
        document.getElementById('chat-container').innerHTML = '';
        estado.conversaAtual = [];
        estado.arquivosAnexados = [];
        mostrarToast('Conversa limpa', 'sucesso');
        
        // Mostrar mensagem de boas-vindas novamente
        setTimeout(() => mostrarMensagemBoasVindas(), 500);
    }
}

function exportarConversa() {
    const mensagens = Array.from(document.querySelectorAll('.mensagem-wrapper'))
        .map(wrapper => {
            const mensagem = wrapper.querySelector('.mensagem');
            const tipo = wrapper.classList.contains('usuario-wrapper') ? 'Usu√°rio' : 'Cici AI';
            const hora = wrapper.querySelector('.mensagem-hora')?.textContent || '';
            const texto = mensagem.childNodes[0].textContent || mensagem.innerText;
            return `[${hora}] ${tipo}: ${texto}`;
        })
        .join('\n\n');

    const blob = new Blob([mensagens], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `cici-chat-${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    mostrarToast('Conversa exportada!', 'sucesso');
}

function compartilharConversa() {
    if (navigator.share) {
        const texto = estado.conversaAtual
            .map(msg => `${msg.role === 'user' ? 'üë§' : 'ü§ñ'} ${msg.content.substring(0, 100)}...`)
            .join('\n');
        
        navigator.share({
            title: 'Minha conversa com Cici AI',
            text: texto,
            url: window.location.href
        }).then(() => {
            mostrarToast('Conversa compartilhada!', 'sucesso');
        }).catch(() => {
            mostrarToast('Compartilhamento cancelado', 'info');
        });
    } else {
        exportarConversa();
    }
}

function imprimirConversa() {
    const estilo = `
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; }
            .mensagem { margin: 10px 0; padding: 10px; border-radius: 8px; }
            .usuario { background: #e3f2fd; margin-left: 20px; }
            .cici { background: #f5f5f5; margin-right: 20px; }
            .hora { font-size: 0.8em; color: #666; text-align: right; }
            @media print {
                .no-print { display: none; }
            }
        </style>
    `;

    const conteudo = Array.from(document.querySelectorAll('.mensagem-wrapper'))
        .map(wrapper => {
            const mensagem = wrapper.querySelector('.mensagem');
            const tipo = wrapper.classList.contains('usuario-wrapper') ? 'usuario' : 'cici';
            const hora = wrapper.querySelector('.mensagem-hora')?.textContent || '';
            const texto = mensagem.childNodes[0].textContent || mensagem.innerText;
            
            return `
                <div class="mensagem ${tipo}">
                    <div>${texto}</div>
                    <div class="hora">${hora}</div>
                </div>
            `;
        })
        .join('');

    const janela = window.open('', '_blank');
    janela.document.write(`
        <html>
            <head>
                <title>Conversa Cici AI</title>
                ${estilo}
            </head>
            <body>
                <h1>Conversa com Cici AI</h1>
                <div>${conteudo}</div>
                <script>
                    window.onload = () => window.print();
                </script>
            </body>
        </html>
    `);
}

// ===== TOAST NOTIFICATIONS =====
function mostrarToast(mensagem, tipo = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast ${tipo}`;
    toast.innerHTML = `
        <span>${mensagem}</span>
    `;

    container.appendChild(toast);

    setTimeout(() => {
        toast.classList.add('mostrar');
    }, 100);

    setTimeout(() => {
        toast.classList.remove('mostrar');
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 400);
    }, 4000);
}

// ===== AJUDA E TUTORIAIS =====
function mostrarAjuda() {
    fecharMenu();
    const ajuda = `# üìö **Como Usar a Cici AI**

## üí¨ **Conversa√ß√£o B√°sica**
- Digite suas perguntas no campo de texto
- Use **Shift+Enter** para nova linha
- **Enter** para enviar a mensagem

## üé§ **Reconhecimento de Voz**
- Clique no microfone para falar
- Suporta portugu√™s brasileiro
- Converte fala em texto automaticamente

## üìé **Anexar Arquivos**
- Suporta: PDF, TXT, DOC, imagens
- M√°ximo: 10MB por arquivo
- An√°lise de texto e conte√∫do

## üé® **Modos de Conversa√ß√£o**
- **‚ú® Criativo**: Respostas imaginativas
- **üéØ Preciso**: Respostas factuais
- **üíª C√≥digo**: Especialista em programa√ß√£o
- **üéì Ensino**: Explica√ß√µes did√°ticas
- **üî¨ An√°lise**: An√°lises profundas

## ‚å®Ô∏è **Atalhos de Teclado**
- **Ctrl+K**: Focar no chat
- **Ctrl+L**: Limpar conversa
- **Ctrl+S**: Exportar conversa
- **Esc**: Fechar menus

Precisa de ajuda com algo espec√≠fico?`;
    adicionarMensagem(ajuda, 'cici', true);
}

function mostrarCapacidades() {
    fecharMenu();
    const capacidades = `# üöÄ **O que posso fazer?**

## üíª **Programa√ß√£o & Tecnologia**
- Gerar c√≥digo em Python, JavaScript, Java, C++, etc.
- Debuggar e explicar c√≥digo
- Criar algoritmos e estruturas de dados
- Explicar conceitos de programa√ß√£o
- Revisar e otimizar c√≥digo

## üìö **Educa√ß√£o & Aprendizado**
- Explicar conceitos complexos de forma simples
- Criar resumos e mapas mentais
- Auxiliar em pesquisas acad√™micas
- Ensinar idiomas e gram√°tica
- Preparar materiais de estudo

## üìÑ **An√°lise de Documentos**
- Ler e resumir textos longos
- Extrair informa√ß√µes principais
- Analisar estrutura e conte√∫do
- Comparar documentos
- Identificar pontos-chave

## üé® **Criatividade & Conte√∫do**
- Escrever textos criativos
- Gerar ideias e brainstorming
- Criar roteiros e hist√≥rias
- Escrever poemas e letras de m√∫sica
- Desenvolver conte√∫do para redes sociais

**Qual √°rea gostaria de explorar?**`;
    adicionarMensagem(capacidades, 'cici', true);
}

function mostrarAtalhos() {
    fecharMenu();
    const atalhos = `# ‚å®Ô∏è **Atalhos de Teclado**

## üîß **Navega√ß√£o Geral**
- **Ctrl + K** ‚Üí Focar no campo de mensagem
- **Ctrl + L** ‚Üí Limpar conversa atual
- **Ctrl + S** ‚Üí Exportar conversa
- **Esc** ‚Üí Fechar menus/di√°logos

## üí¨ **Campo de Mensagem**
- **Enter** ‚Üí Enviar mensagem
- **Shift + Enter** ‚Üí Nova linha

## üîä **Acessibilidade**
- **Ctrl + +** ‚Üí Aumentar fonte
- **Ctrl + -** ‚Üí Diminuir fonte
- **Ctrl + 0** ‚Üí Fonte padr√£o

*Dica: Muitas fun√ß√µes tamb√©m est√£o acess√≠veis pelo menu de configura√ß√µes!*`;
    adicionarMensagem(atalhos, 'cici', true);
}

// ===== SERVICE WORKER (PWA) =====
if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js')
            .then(registration => {
                console.log('SW registered: ', registration);
            })
            .catch(registrationError => {
                console.log('SW registration failed: ', registrationError);
            });
    });
}

// Inicializa√ß√£o final
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Cici AI inicializada com sucesso!');
    // Focar no input ap√≥s carregamento
    setTimeout(() => {
        const input = document.getElementById('entradaUsuario');
        if (input) input.focus();
    }, 1000);
});
